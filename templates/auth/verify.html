{% extends "auth/layout.html" %}
{% block content %}
  <h1>Подтвердите вход</h1>
  <p class="subtitle">Введите 6-значный код. Он действует 10 минут.</p>
  <form method="post" class="auth-form">
    <label>
      Код из сообщения
      <input type="text" name="code" maxlength="6" inputmode="numeric" required />
    </label>
    <button class="primary-btn" type="submit">Подтвердить</button>
  </form>
  <div class="otp-countdown" data-otp-sent-at="{{ session.get('otp_sent_at') or '' }}">
    Повторно запросить код можно через <span data-otp-seconds>60</span> секунд.
  </div>
  <p class="auth-hint">
    Код не пришёл? Запросите новый код на странице входа.
  </p>
  <script>
    (function () {
      const countdown = document.querySelector("[data-otp-sent-at]");
      if (!countdown) return;
      const secondsNode = countdown.querySelector("[data-otp-seconds]");
      const rawSentAt = countdown.dataset.otpSentAt;
      let secondsLeft = 60;
      if (rawSentAt) {
        const sentAtMs = Number(rawSentAt) * 1000;
        if (!Number.isNaN(sentAtMs)) {
          const elapsed = Math.floor((Date.now() - sentAtMs) / 1000);
          secondsLeft = Math.max(0, 60 - elapsed);
        }
      }
      const tick = () => {
        if (secondsNode) secondsNode.textContent = String(secondsLeft);
        if (secondsLeft <= 0) {
          return;
        }
        secondsLeft -= 1;
        setTimeout(tick, 1000);
      };
      tick();
    })();
  </script>
{% endblock %}
