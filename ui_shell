<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="theme-color" content="#1A73E8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <style>
      /* ===== Глобальные стили ===== */
      :root {
        --primary-color: #2f80ff;
        --primary-light: #5a9bff;
        --primary-dark: #1e6bff;
        --secondary-color: #34c759;
        --error-color: #ea4335;
        --warning-color: #fbbc05;
        --bg-app: #e7edf5;
        --bg-surface: #f7f9fc;
        --bg-card: #ffffff;
        --border-color: rgba(30, 41, 59, 0.08);
        --text-main: #0f172a;
        --text-muted: #64748b;
        --glass-bg: rgba(255, 255, 255, 0.82);
        --glass-border: rgba(226, 232, 240, 0.9);
        --glass-hover: rgba(30, 41, 59, 0.06);
        --glass-shadow: 0 12px 36px rgba(30, 41, 59, 0.12);
        --premium-shadow: 0 18px 40px -18px rgba(30, 41, 59, 0.35);
        --bg-gradient: radial-gradient(circle at 20% 0%, rgba(122, 162, 255, 0.25), transparent 55%),
          radial-gradient(circle at 80% 10%, rgba(138, 102, 255, 0.2), transparent 52%),
          linear-gradient(180deg, #e7edf5 0%, #f3f6fb 60%, #e8edf6 100%);
        --background-color: var(--bg-surface);
        --surface-color: var(--bg-app);
        --surface-strong: #0f1b34;
        --on-surface-color: var(--text-main);
        --on-surface-secondary-color: var(--text-muted);
        --divider-color: var(--border-color);
        --border-radius: 12px;
        --shadow-elevation-1: var(--glass-shadow);
        --shadow-elevation-2: 0 16px 36px rgba(31, 38, 135, 0.12);
        --shadow-elevation-4: 0 20px 50px rgba(31, 38, 135, 0.16);
        --shadow-elevation-8: 0 28px 64px rgba(31, 38, 135, 0.2);
        --font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        --font-size-small: 12px;
        --font-size-medium: 14px;
        --font-size-large: 16px;
        --font-size-xlarge: 18px;
        --font-weight-regular: 400;
        --font-weight-medium: 500;
        --font-weight-bold: 700;
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
      }
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: var(--font-family);
        font-size: var(--font-size-medium);
        color: var(--on-surface-color);
        background-color: var(--bg-app);
        background-image: var(--bg-gradient);
        overflow: hidden; /* Чтобы не было скролла у body */
      }
      /* ===== Основной контейнер ===== */
      .app-root {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        box-shadow: none;
        border-radius: 0;
        overflow: hidden;
        background-color: transparent;
      }
      /* ===== Глобальный экран загрузки ===== */
      .app-loading-overlay {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: radial-gradient(circle at center, #0f172a 0%, #020617 45%, #000000 100%);
        overflow: hidden;
        z-index: 30000;
        transition: opacity 0.6s ease, visibility 0.6s ease, transform 0.6s ease, filter 0.6s ease;
      }
      .app-loading-overlay.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transform: scale(1.08);
        filter: blur(18px);
      }
      .app-loading-bg {
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at center, rgba(148, 163, 184, 0.08), transparent 55%);
      }
      .app-loading-glow {
        position: absolute;
        width: 520px;
        height: 520px;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(248, 250, 252, 0.08), transparent 65%);
        filter: blur(80px);
        opacity: 0.65;
      }
      .app-loading-center {
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 22px;
        color: #e2e8f0;
      }
      .app-loading-logo {
        width: 140px;
        height: 110px;
      }
      .app-loading-logo path {
        stroke: url(#liquidMetal);
        stroke-width: 1;
        stroke-linecap: round;
        stroke-linejoin: round;
        fill: none;
      }
      .app-loading-p-left {
        stroke-dasharray: 240;
        stroke-dashoffset: 240;
        animation: logoDraw 1.4s ease-in-out forwards;
      }
      .app-loading-p-right {
        stroke-dasharray: 240;
        stroke-dashoffset: 240;
        animation: logoDraw 1.4s ease-in-out forwards;
        animation-delay: 0.5s;
      }
      .app-loading-smile {
        stroke-dasharray: 260;
        stroke-dashoffset: 260;
        animation: smileDraw 1.4s ease-in-out forwards;
        animation-delay: 1.8s;
      }
      .app-loading-eye {
        transform-origin: center;
        opacity: 0;
        animation: eyePop 0.4s ease-out forwards;
        animation-delay: 2.2s;
      }
      .app-loading-eye.right {
        animation-delay: 2.35s;
      }
      .app-loading-eye.blink {
        animation: eyePop 0.4s ease-out forwards, eyeBlink 0.2s ease-in-out 3.5s;
      }
      .app-loading-eye.right.blink {
        animation: eyePop 0.4s ease-out forwards, eyeBlink 0.2s ease-in-out 3.5s;
      }
      .app-loading-title {
        font-size: 14px;
        font-weight: 300;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: #e2e8f0;
        text-shadow: 0 0 18px rgba(255, 255, 255, 0.18);
        animation: textRise 1.6s ease-out forwards;
        animation-delay: 2.5s;
        opacity: 0;
        transform: translateY(10px);
      }
      .app-loading-line {
        position: absolute;
        bottom: 12%;
        width: 140px;
        height: 1px;
        background: rgba(148, 163, 184, 0.2);
        overflow: hidden;
      }
      .app-loading-line::after {
        content: "";
        position: absolute;
        inset: 0;
        transform: translateX(-100%);
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.9), transparent);
        animation: monoScan 2.6s ease-in-out forwards;
        animation-delay: 2.2s;
      }
      @keyframes logoDraw {
        0% { stroke-dashoffset: 240; opacity: 0; }
        100% { stroke-dashoffset: 0; opacity: 1; }
      }
      @keyframes smileDraw {
        0% { stroke-dashoffset: 260; opacity: 0; }
        100% { stroke-dashoffset: 0; opacity: 1; }
      }
      @keyframes eyePop {
        0% { opacity: 0; transform: scale(0.6); }
        100% { opacity: 1; transform: scale(1); }
      }
      @keyframes eyeBlink {
        0%, 100% { transform: scaleY(1); }
        50% { transform: scaleY(0.1); }
      }
      @keyframes textRise {
        0% { opacity: 0; letter-spacing: 0.2em; transform: translateY(10px); }
        100% { opacity: 1; letter-spacing: 0.5em; transform: translateY(0); }
      }
      @keyframes monoScan {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }
      @keyframes smileWink {
        0%, 92%, 100% { transform: scaleY(1); }
        94% { transform: scaleY(0.15); }
        96% { transform: scaleY(1); }
      }
      @keyframes smilePulse {
        0%, 100% { transform: scale(1); opacity: 0.9; }
        50% { transform: scale(1.06); opacity: 1; }
      }
      /* ===== Шапка приложения ===== */
      .app-header {
        display: none;
      }
      .theme-toggle-btn {
        border: none;
        border-radius: 12px;
        width: 44px;
        height: 44px;
        padding: 0;
        background: rgba(15, 23, 42, 0.85);
        color: #e2e8f0;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.12s ease;
      }
      .theme-toggle-btn:hover {
        background: rgba(30, 41, 59, 0.9);
        border-color: rgba(59, 130, 246, 0.4);
      }
      .theme-toggle-btn:active {
        transform: translateY(1px);
      }
      /* ===== Основной контент ===== */
      .app-main {
        flex: 1;
        display: flex;
        overflow: hidden;
        background: transparent;
      }
      /* ===== Левое меню ===== */
      .left-menu {
        width: 260px;
        flex: 0 0 260px;
        background: linear-gradient(180deg, #0b1220 0%, #0f172a 100%);
        border-right: none;
        display: flex;
        flex-direction: column;
        padding: 18px 0 22px;
        box-sizing: border-box;
        overflow: hidden;
        color: #cbd5f5;
        box-shadow: none;
        backdrop-filter: none;
        transition: width 0.28s ease, flex-basis 0.28s ease, padding 0.28s ease, opacity 0.2s ease, transform 0.28s ease;
      }
      .app-root.sidebar-collapsed .left-menu {
        width: 72px;
        flex-basis: 72px;
        padding: 14px 0 18px;
        border-right: none;
        opacity: 1;
        transform: translateX(0);
        pointer-events: auto;
      }
      .app-root.sidebar-collapsed .left-menu-logo,
      .app-root.sidebar-collapsed .left-menu-title,
      .app-root.sidebar-collapsed .left-menu-footer {
        display: none;
      }
      .app-root.sidebar-collapsed .left-menu-item {
        justify-content: center;
        padding: 12px 0;
        margin: 0 10px 8px;
      }
      .app-root.sidebar-collapsed .left-menu-label {
        display: none;
      }
      .left-menu-logo {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0 20px 18px;
        margin-bottom: 12px;
        border-bottom: none;
      }
      .left-menu-badge {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        background: linear-gradient(135deg, #2f80ff 0%, #1e6bff 100%);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.4);
        position: relative;
      }
      .left-menu-badge::after {
        content: "";
        position: absolute;
        inset: -10px;
        background: radial-gradient(circle, rgba(96, 165, 250, 0.2), transparent 70%);
        z-index: -1;
        filter: blur(8px);
      }
      .left-menu-badge-smile {
        font-size: 0;
      }
      .left-menu-badge-smile svg {
        width: 22px;
        height: 22px;
        color: #ffffff;
      }
      .left-menu-badge-smile .smile-eye {
        transform-origin: center;
        animation: smileWink 6s ease-in-out infinite;
      }
      .left-menu-badge-smile .smile-eye.right {
        animation-delay: 3s;
      }
      .left-menu-badge-smile .smile-smile {
        animation: smilePulse 4.5s ease-in-out infinite;
        transform-origin: center;
      }
      .left-menu-logo-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .left-menu-logo-text .title {
        color: #f8fafc;
        font-weight: 700;
        font-size: 16px;
      }
      .left-menu-logo-text .subtitle {
        color: #93c5fd;
        font-size: 11px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
      }
      .left-menu-title {
        padding: 0 20px 10px 20px;
        font-size: 11px;
        font-weight: 700;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.8px;
      }
      .left-menu-item {
        padding: 12px 18px;
        margin: 0 12px 6px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        color: #cbd5f5;
        border-radius: 14px;
        transition: background-color 0.2s ease, color 0.2s ease, transform 0.12s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
      }
      .left-menu-item:hover {
        background-color: rgba(30, 41, 59, 0.7);
        color: #f8fafc;
        transform: translateX(4px);
      }
      .left-menu-item.active {
        position: relative;
        background: linear-gradient(90deg, rgba(59, 130, 246, 0.35), rgba(15, 23, 42, 0.2));
        color: #ffffff;
        font-weight: 700;
      }
      .left-menu-footer {
        margin-top: auto;
        padding: 10px 16px 0;
        display: flex;
        gap: 10px;
      }
      .left-menu-archive-btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.85);
        color: #e2e8f0;
        font-weight: 700;
        font-size: 16px;
        padding: 0;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 2px;
        transition: transform 0.12s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      }
      .left-menu-archive-btn:hover {
        background: rgba(30, 41, 59, 0.9);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.35);
        transform: translateY(-1px);
      }
      .left-menu-archive-btn:active {
        transform: translateY(0);
        box-shadow: 0 8px 16px rgba(0,0,0,0.18);
      }
      .left-menu-archive-btn:disabled {
        opacity: 0.6;
        cursor: progress;
        box-shadow: none;
        transform: none;
      }
      .archive-file-label {
        font-size: 11px;
        font-weight: 800;
        letter-spacing: 0.4px;
        padding: 2px 6px;
        border-radius: 6px;
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
      }
      .archive-download-hint {
        font-size: 14px;
        line-height: 1;
      }
      .left-menu-snow-btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.85);
        color: #e2e8f0;
        font-weight: 700;
        font-size: 18px;
        padding: 0;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.12s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      }
      .left-menu-snow-btn:hover {
        background: rgba(30, 41, 59, 0.9);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.35);
        transform: translateY(-1px);
      }
      .left-menu-snow-btn:active {
        transform: translateY(0);
        box-shadow: 0 8px 16px rgba(0,0,0,0.18);
      }
      .snow-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        overflow: hidden;
        z-index: 99999;
        opacity: 0.96;
      }
      .snowflake {
        position: absolute;
        color: #d7dde9;
        user-select: none;
        will-change: transform;
        animation-name: fall;
        animation-timing-function: linear;
        animation-iteration-count: infinite;
      }
      @keyframes fall {
        0% { transform: translate3d(var(--x-start, 0), -10%, 0) rotate(0deg); opacity: 0; }
        10% { opacity: 0.8; }
        100% { transform: translate3d(var(--x-end, 0), 110vh, 0) rotate(360deg); opacity: 0; }
      }
      .left-menu-icon {
        width: 28px;
        height: 28px;
        border-radius: 10px;
        background: rgba(15, 23, 42, 0.7);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #cbd5f5;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 8px 16px rgba(0, 0, 0, 0.35);
        transition: transform 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      }
      .left-menu-icon svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        stroke-width: 1.8;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .left-menu-item:hover .left-menu-icon {
        color: #f8fafc;
        background: rgba(59, 130, 246, 0.2);
      }
      .left-menu-item.active .left-menu-icon {
        color: #bfdbfe;
        background: rgba(59, 130, 246, 0.3);
        transform: scale(1.1);
        box-shadow: 0 10px 20px rgba(59, 130, 246, 0.35);
        animation: iconBounce 0.5s ease;
      }
      @keyframes iconBounce {
        0% { transform: scale(1); }
        40% { transform: scale(1.18); }
        100% { transform: scale(1.1); }
      }
      /* ===== Рабочая область (вкладки + содержимое) ===== */
      .workspace {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: transparent;
        min-width: 0;
      }
      /* ===== Вкладки ===== */
      .tabs-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: none;
        background-color: transparent;
        padding: 8px 10px;
        box-shadow: none;
        backdrop-filter: none;
      }
      .sidebar-toggle-btn {
        width: 56px;
        height: 30px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: 999px;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        color: #3b82f6;
        padding: 3px;
        display: inline-flex;
        align-items: center;
        justify-content: flex-start;
        cursor: pointer;
        position: relative;
        box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
        transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, transform 0.12s ease;
      }
      .sidebar-toggle-btn::before {
        content: "";
        position: absolute;
        left: 3px;
        top: 3px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #ffffff;
        box-shadow: 0 8px 16px rgba(15, 23, 42, 0.18);
        transition: transform 0.24s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      }
      .sidebar-toggle-btn:hover {
        background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%);
        color: var(--text-main);
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.16);
      }
      .sidebar-toggle-btn:active {
        transform: translateY(1px);
      }
      .sidebar-toggle-icon {
        display: none;
      }
      .app-root.sidebar-collapsed .sidebar-toggle-btn {
        background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
        border-color: rgba(37, 99, 235, 0.35);
        color: #1d4ed8;
        box-shadow: 0 12px 26px rgba(59, 130, 246, 0.25);
      }
      .app-root.sidebar-collapsed .sidebar-toggle-btn::before {
        transform: translateX(26px);
        background: #ffffff;
      }
      .tabs {
        flex: 1;
        display: flex;
        overflow-x: auto;
        overflow-y: hidden;
        scrollbar-width: thin;
        scrollbar-color: var(--on-surface-secondary-color) var(--divider-color);
      }
      .tabs::-webkit-scrollbar {
        height: 8px;
      }
      .tabs::-webkit-scrollbar-track {
        background: var(--divider-color);
      }
      .tabs::-webkit-scrollbar-thumb {
        background-color: var(--on-surface-secondary-color);
        border-radius: 4px;
      }
      .tab {
        padding: 10px 16px;
        margin: 0 6px 0 0;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 700;
        color: #5b6b82;
        background-color: transparent;
        border: 1px solid transparent;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      }
      .tab:hover {
        background-color: rgba(226, 232, 240, 0.6);
        color: #1e293b;
        box-shadow: none;
      }
      .tab.active {
        background-color: #ffffff;
        color: #1d4ed8;
        border: 1px solid rgba(99, 102, 241, 0.18);
        box-shadow: 0 16px 30px rgba(30, 41, 59, 0.16);
        transform: scale(1.05);
      }
      .tab-close {
        margin-left: var(--spacing-xs);
        cursor: pointer;
        font-weight: var(--font-weight-bold);
        color: #94a3b8;
        opacity: 1;
        transition: opacity 0.2s ease, background-color 0.2s ease;
        font-size: var(--font-size-large);
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 50%;
      }
      .tab:hover .tab-close,
      .tab.active .tab-close {
        opacity: 1;
      }
      .tab-close:hover {
        opacity: 1;
        background-color: #fee2e2;
        color: #ef4444;
      }
      /* ===== Контейнер содержимого вкладки ===== */
      .tab-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-width: 0;
      }
      /* ===== Тулбар вкладки ===== */
      .tab-toolbar {
        padding: 14px 18px;
        border-bottom: none;
        background-color: transparent;
        display: flex;
        align-items: center;
        gap: 12px;
        min-height: 56px;
        box-sizing: border-box;
        flex-wrap: nowrap;
        overflow-x: auto;
        overflow-y: hidden;
        box-shadow: none;
        backdrop-filter: none;
      }
      .tab-toolbar > * {
        flex: 0 0 auto;
      }
      .tab-toolbar:empty {
        display: none;
      }
      .tab-toolbar-title {
        font-weight: 800;
        margin-right: 12px;
        color: var(--text-main);
        font-size: 18px;
      }
      /* ===== Кнопки в тулбаре ===== */
      .toolbar-button {
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        background-color: var(--bg-surface);
        color: var(--text-main);
        cursor: pointer;
        font-size: 14px;
        font-weight: 700;
        transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, transform 0.12s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-height: 40px;
      }
      .toolbar-button:hover {
        background-color: #f1f5f9;
        box-shadow: var(--premium-shadow);
        transform: translateY(-1px);
        border-color: #94a3b8;
      }
      .toolbar-button:active {
        box-shadow: inset 0 1px 2px 0 rgba(12, 34, 70, 0.12);
        transform: translateY(0);
      }
      /* ===== Сабтулбар (фильтры, поиск) ===== */
      .subtoolbar {
        padding: 10px 18px;
        border-bottom: none;
        background-color: transparent;
        display: flex;
        align-items: center;
        gap: 14px;
        font-size: 14px;
        min-height: 48px;
        box-sizing: border-box;
        flex-wrap: nowrap;
        overflow-x: auto;
        overflow-y: hidden;
      }
      .subtoolbar > * {
        flex: 0 0 auto;
      }
      .subtoolbar:empty {
        display: none;
      }
      .panel-loading {
        padding: 32px;
        display: inline-flex;
        align-items: center;
        gap: 12px;
        color: var(--on-surface-color);
        font-size: var(--font-size-large);
        animation: fadeIn 0.18s ease;
      }
      .panel-loading .spinner {
        width: 20px;
        height: 20px;
        border: 3px solid #e8eaed;
        border-top-color: #4285f4;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      .subtoolbar select,
      .subtoolbar input[type="text"],
      .subtoolbar input[type="search"] {
        font-size: var(--font-size-medium);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--border-radius);
        border: none;
        background-color: #f8fafc;
        color: var(--text-main);
        box-sizing: border-box;
        box-shadow: 0 10px 22px rgba(15, 23, 42, 0.08), inset 0 1px 2px rgba(255, 255, 255, 0.7);
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
      }
        .subtoolbar select:focus,
        .subtoolbar input[type="text"]:focus,
        .subtoolbar input[type="search"]:focus {
          outline: none;
          border-color: var(--primary-color);
          box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
          background-color: #ffffff;
        }
        .date-input-wrapper {
          position: relative;
          display: inline-flex;
          align-items: center;
        }
      .date-input {
        padding: 8px 12px 8px 40px;
        border-radius: 999px;
        border: none;
        background-color: #f8fafc;
        min-width: 160px;
        box-shadow: 0 10px 22px rgba(15, 23, 42, 0.08), inset 0 1px 2px rgba(255, 255, 255, 0.7);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
        .date-input:focus {
          outline: none;
          border-color: var(--primary-color);
          box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
          background-color: #ffffff;
        }
        .date-input-icon {
          position: absolute;
          left: 12px;
          width: 18px;
          height: 18px;
          pointer-events: none;
          color: var(--primary-color);
          opacity: 1;
        }
      /* ===== Область данных (таблица, форма) ===== */
      .data-area {
        flex: 1;
        overflow: auto;
        padding: 18px 22px 24px;
        background-color: transparent;
        border-radius: 0;
        box-shadow: none;
        display: flex;
        flex-direction: column;
      }
      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
        gap: var(--spacing-md);
      }
      .card {
        background: var(--glass-bg);
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--glass-shadow);
        backdrop-filter: blur(24px);
        padding: var(--spacing-md);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
      }
      .card:hover {
        transform: translateY(-4px);
        box-shadow: var(--premium-shadow);
      }
      .card-title {
        font-weight: var(--font-weight-bold);
        font-size: var(--font-size-large);
        color: var(--text-main);
      }
      .card-subtitle {
        color: var(--text-muted);
        font-size: var(--font-size-small);
      }
      .table-wrapper {
        overflow: auto;
        border: none;
        border-radius: var(--border-radius);
      }
      .data-table {
        width: 100%;
        border-collapse: collapse;
      }
      .data-table th, .data-table td {
        border: none;
        padding: 6px 8px;
        text-align: center;
        background: #fff;
      }
      .data-table input {
        width: 100%;
        border: none;
        outline: none;
        background: transparent;
        text-align: center;
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: var(--spacing-md);
      }
      .form-grid label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: var(--font-size-small);
        color: var(--on-surface-secondary-color);
      }
      .form-grid input, .form-grid select {
        padding: 10px 12px;
        border-radius: var(--border-radius);
        border: 1px solid var(--divider-color);
        background: #f8fafc;
        color: var(--text-main);
        box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.06);
      }
      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-sm);
      }
      /* ===== Главная ===== */
      .shell-breadcrumbs {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .breadcrumb-pill {
        padding: 10px 14px;
        border-radius: 12px;
        border: none;
        background: var(--glass-bg);
        color: var(--text-muted);
        font-weight: 700;
        box-shadow: var(--glass-shadow);
        backdrop-filter: blur(18px);
      }
      .breadcrumb-pill.active {
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        color: var(--text-main);
      }
      .home-period-picker {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        background: var(--glass-bg);
        border: none;
        box-shadow: var(--glass-shadow);
        backdrop-filter: blur(18px);
      }
      .home-period-label {
        color: var(--text-muted);
        font-weight: 600;
      }
      .date-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 12px;
        border: none;
        background: #f1f5f9;
        min-width: 150px;
        color: var(--text-main);
        font-weight: 700;
        box-shadow: 0 10px 22px rgba(15, 23, 42, 0.08), inset 0 1px 2px rgba(255, 255, 255, 0.7);
      }
      .date-chip input {
        border: none;
        background: transparent;
        width: 100%;
        font-weight: 700;
        color: var(--text-main);
      }
      .date-chip input:focus {
        outline: none;
      }
      .home-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 18px;
        padding: 4px;
        animation: fadeIn 0.2s ease;
      }
      .home-card {
        background: var(--glass-bg);
        border: none;
        border-radius: 16px;
        box-shadow: var(--glass-shadow);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        height: 520px;
        overflow: hidden;
        backdrop-filter: blur(24px);
        transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
      }
      .home-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--premium-shadow);
      }
      .home-plan-card {
        height: 520px;
      }
      .home-plan-card .home-list {
        overflow-y: auto;
      }
      .home-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 800;
        font-size: 18px;
        color: var(--text-main);
      }
      .home-card-subtitle {
        color: var(--text-muted);
        font-weight: 600;
        font-size: 13px;
        margin-left: auto;
      }
      .home-stats {
        display: grid;
        grid-template-columns: repeat(2, minmax(120px, 1fr));
        gap: 12px;
      }
      .home-stat {
        border-radius: 14px;
        padding: 14px;
        border: none;
        background: #f8fafc;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);
      }
      .home-stat:nth-child(2) {
        background: #f8fafc;
      }
      .home-stat-label {
        color: var(--text-muted);
        font-size: 13px;
        margin-bottom: 4px;
        font-weight: 600;
      }
      .home-stat-value {
        font-size: 28px;
        font-weight: 800;
        color: var(--text-main);
      }
      .home-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .btn-primary {
        background: linear-gradient(180deg, #2f80ff 0%, #1e6bff 100%);
        color: #ffffff;
        border-color: #1e6bff;
        box-shadow: 0 12px 24px rgba(59, 130, 246, 0.3);
      }
      .btn-primary:hover {
        background: linear-gradient(180deg, #1e6bff 0%, #1b64f0 100%);
        color: #ffffff;
      }
      .btn-ghost {
        background: rgba(226, 232, 240, 0.6);
        color: #475569;
        border-color: #cbd5e1;
      }
      .toolbar-button.btn-ghost:hover {
        background: #e2e8f0;
        color: var(--text-main);
        border-color: #94a3b8;
      }
      .home-page-heading {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
        padding: 0 4px;
      }
      .home-page-title {
        font-size: 22px;
        font-weight: 800;
        color: var(--text-main);
      }
      .home-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex: 1;
        min-height: 0;
        overflow: auto;
        padding-right: 4px;
      }
      .home-list-item {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        padding: 12px 14px;
        border: none;
        border-radius: 14px;
        background: var(--bg-card);
        color: var(--text-main);
        font-weight: 700;
      }
      .home-list-meta {
        color: var(--text-muted);
        font-size: 12px;
        font-weight: 600;
        margin-top: 4px;
      }
      .home-empty {
        color: #94a3b8;
        font-size: 14px;
        padding: 12px 0;
        text-align: center;
      }
      .home-plan-day {
        border: none;
        border-radius: 14px;
        overflow: hidden;
        background: #f8fafc;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);
        flex-shrink: 0;
      }
      .home-plan-day-title {
        padding: 12px 14px;
        font-weight: 800;
        background: #faf5ff;
        color: #7c3aed;
        border-bottom: none;
      }
      .home-plan-day-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 12px;
      }
      .home-plan-pill {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 140px;
        column-gap: 14px;
        padding: 12px 14px;
        background: var(--bg-card);
        border: none;
        border-radius: 14px;
        box-shadow: var(--glass-shadow);
        cursor: pointer;
        transition: transform 0.14s ease, box-shadow 0.14s ease, background-color 0.14s ease;
        align-items: center;
      }
      .home-plan-pill:hover {
        transform: translateY(-2px);
        box-shadow: var(--premium-shadow);
        background: #f8fafc;
      }
      .home-plan-left {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
      }
      .home-plan-org {
        font-weight: 700;
        color: var(--text-main);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .home-plan-item {
        color: var(--primary-color);
        font-weight: 700;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .home-plan-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
        white-space: nowrap;
        width: 140px;
        flex-shrink: 0;
      }
      .app-root.sidebar-collapsed .home-plan-pill {
        grid-template-columns: minmax(0, 1fr) 120px;
      }
      .app-root.sidebar-collapsed .home-plan-meta {
        width: 120px;
      }
      .home-plan-qty {
        background: #e2e8f0;
        color: var(--text-main);
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 800;
        justify-self: flex-start;
      }
      .home-plan-link {
        color: var(--text-main);
        font-size: 12px;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        text-align: right;
      }
      .home-drive-list {
        max-height: none;
        min-height: 140px;
      }
      .home-drive-row {
        padding: 12px 14px;
        border: none;
        border-radius: 12px;
        background: var(--bg-card);
        display: flex;
        justify-content: space-between;
        gap: 12px;
        cursor: pointer;
        transition: background-color 0.12s ease, box-shadow 0.12s ease, transform 0.12s ease;
      }
      .home-drive-row:hover {
        background: #f8fafc;
        box-shadow: var(--glass-shadow);
        transform: translateY(-1px);
      }
      .home-drive-name {
        font-weight: 700;
        color: var(--text-main);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .home-drive-meta {
        color: var(--text-muted);
        font-size: 12px;
      }
      .home-drive-search {
        display: flex;
        justify-content: center;
        padding: 0 8px 8px;
      }
      .home-drive-search input {
        width: 100%;
        max-width: 520px;
        padding: 12px 14px;
        border: none;
        border-radius: 12px;
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.08), inset 0 1px 2px rgba(255, 255, 255, 0.7);
        background: #f8fafc;
        color: var(--text-main);
      }
      .home-drive-search input::placeholder {
        color: #94a3b8;
      }
      .home-upload-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.2);
        display: none;
        align-items: flex-start;
        justify-content: center;
        z-index: 20000;
        backdrop-filter: blur(2px);
        overflow: auto;
        padding: 24px 12px;
      }
      .home-upload-window {
        width: min(540px, 95vw);
        background: var(--bg-surface);
        border-radius: 16px;
        box-shadow: var(--shadow-elevation-8);
        overflow: auto;
        animation: fadeIn 0.18s ease;
        max-height: 90vh;
      }
      .home-upload-header {
        padding: 16px 18px;
        font-weight: 800;
        font-size: 18px;
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        background: var(--bg-surface);
      }
      .home-upload-body {
        padding: 16px 18px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow: auto;
      }
      .home-upload-actions {
        padding: 12px 18px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      .home-dropzone {
        border: 2px dashed #cbd5e1;
        border-radius: 14px;
        padding: 20px;
        text-align: center;
        color: var(--text-muted);
        background: #f8fafc;
        cursor: pointer;
        transition: border-color 0.14s ease, background-color 0.14s ease, color 0.14s ease;
        font-weight: 700;
      }
      .home-dropzone.dragover {
        border-color: #1e6bff;
        background: #eff6ff;
        color: var(--primary-color);
      }
      .home-dropzone.uploading {
        opacity: 0.7;
        pointer-events: none;
      }
      .home-upload-hint {
        color: var(--text-muted);
        font-size: 12px;
      }
      .home-period-picker input {
        min-width: 120px;
      }
      /* ===== Таблицы ===== */
      table.data-table {
        border-collapse: collapse;
        width: 100%;
        font-size: var(--font-size-medium);
        table-layout: fixed;
        background-color: var(--background-color);
        border: 1px solid var(--divider-color);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-elevation-1);
      }
      table.data-table th,
      table.data-table td {
        border-right: 1px solid var(--divider-color);
        border-bottom: 1px solid var(--divider-color);
        padding: var(--spacing-sm) var(--spacing-sm);
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        height: 40px; /* Увеличиваем высоту ячейки */
        line-height: 24px;
        vertical-align: middle;
      }
      table.data-table th:last-child,
      table.data-table td:last-child {
        border-right: none;
      }
      table.data-table tr:last-child td {
        border-bottom: none;
      }
      table.data-table th {
        background-color: #f8fafc; /* Цвет заголовка таблицы */
        position: sticky;
        top: 0;
        z-index: 10;
        font-weight: var(--font-weight-medium);
        color: var(--on-surface-color);
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s ease;
      }
      table.data-table th:hover {
        background-color: #e2e8f0;
      }
      table.data-table tr:nth-child(even) td {
        background-color: #f8fafc; /* Цвет чётных строк */
      }
      .data-row {
        transition: background-color 0.18s ease, box-shadow 0.18s ease;
        cursor: pointer;
      }
      .data-row:not(.data-row-selected):hover td {
        background-color: #eff6ff !important; /* Цвет ховера строки */
        box-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.05);
      }
      .data-row-selected td {
        background-color: #dbeafe !important; /* Цвет выбранной строки */
        box-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.08);
      }
      .data-row.data-row-selected:hover td {
        background-color: #dbeafe !important;
      }
      /* ===== Ресайзер колонок ===== */
      .col-resizer {
        position: absolute;
        top: 0;
        right: 0;
        width: 5px;
        height: 100%;
        cursor: col-resize;
        user-select: none;
      }
      /* ===== Нижняя панель ===== */
      .bottom-panel {
        display: none;
        border-top: none;
        padding: 0;
        height: 0;
      }
      .chart-block {
        flex: 1;
        border: 1px solid var(--divider-color);
        background-color: var(--background-color);
        padding: var(--spacing-sm);
        box-sizing: border-box;
        font-size: var(--font-size-small);
        border-radius: var(--border-radius);
        display: flex;
        flex-direction: column;
      }
      .chart-title {
        font-weight: var(--font-weight-medium);
        margin-bottom: var(--spacing-xs);
        color: var(--on-surface-secondary-color);
      }
      /* ===== Контекстное меню ===== */
      .row-context-menu {
        position: fixed;
        z-index: 10000;
        background-color: var(--background-color);
        border: 1px solid var(--divider-color);
        box-shadow: var(--shadow-elevation-4);
        min-width: 180px;
        font-size: var(--font-size-medium);
        border-radius: var(--border-radius);
        overflow: hidden;
        max-height: 300px; /* Ограничиваем высоту */
        overflow-y: auto;
      }
      .row-context-item {
        padding: var(--spacing-sm) var(--spacing-md);
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }
      .row-context-item:hover {
        background-color: #f1f3f4;
      }
      .row-context-item-danger {
        color: var(--error-color);
      }
      .row-context-item-danger:hover {
        background-color: #fce8e6;
      }
      /* ===== Модальные диалоги приложения ===== */
      .dialog-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 20000;
        backdrop-filter: blur(2px); /* Лёгкий блюр фона */
      }
      .dialog-window {
        background-color: var(--background-color);
        border-radius: var(--border-radius);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-elevation-8);
        min-width: 320px;
        max-width: 500px;
        box-sizing: border-box;
        max-height: 90vh;
        overflow-y: auto;
      }
      .dialog-title {
        font-weight: var(--font-weight-bold);
        font-size: var(--font-size-large);
        margin-bottom: var(--spacing-sm);
        color: var(--on-surface-color);
        padding-bottom: var(--spacing-sm);
        border-bottom: 1px solid var(--divider-color);
      }
      .dialog-message {
        font-size: var(--font-size-medium);
        line-height: 1.5;
        margin-bottom: var(--spacing-lg);
        color: var(--on-surface-secondary-color);
        white-space: pre-wrap; /* Для переноса строк в сообщении */
      }
      .dialog-buttons {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
      }
      .dialog-btn {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--border-radius);
        border: 1px solid var(--divider-color);
        background-color: var(--background-color);
        color: var(--on-surface-color);
        cursor: pointer;
        font-size: var(--font-size-medium);
        font-weight: var(--font-weight-medium);
        min-width: 70px;
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
      }
      .dialog-btn:hover {
        background-color: #f1f3f4;
      }
      .dialog-btn-primary {
        border-color: var(--primary-dark);
        background-color: var(--primary-color);
        color: white;
      }
      .dialog-btn-primary:hover {
        background-color: var(--primary-dark);
      }

      /* ===== Темная тема (зеркало светлой) ===== */
      body.theme-dark {
        background-color: #020617;
        color: #f8fafc;
        background-image: radial-gradient(circle at 20% 0%, rgba(59, 130, 246, 0.12), transparent 55%),
          radial-gradient(circle at 80% 10%, rgba(99, 102, 241, 0.1), transparent 52%),
          linear-gradient(180deg, #020617 0%, #0b1220 60%, #020617 100%);
      }
      body.theme-dark .app-root {
        background-color: transparent;
      }
      body.theme-dark .app-header {
        display: none;
      }
      body.theme-dark .left-menu {
        background: linear-gradient(180deg, #0b1220 0%, #0f172a 100%);
        border-right: none;
        color: #cbd5f5;
        box-shadow: none;
        backdrop-filter: none;
      }
      body.theme-dark .left-menu-title,
      body.theme-dark .left-menu-logo-text .title,
      body.theme-dark .left-menu-logo-text .subtitle {
        color: #e2e8f0;
      }
      body.theme-dark .left-menu-item {
        color: #94a3b8;
      }
      body.theme-dark .left-menu-item:hover {
        background-color: rgba(30, 41, 59, 0.7);
        color: #f8fafc;
      }
      body.theme-dark .left-menu-item.active {
        background: linear-gradient(90deg, rgba(59, 130, 246, 0.35), rgba(15, 23, 42, 0.2));
        color: #ffffff;
      }
      body.theme-dark .left-menu-icon {
        background: rgba(15, 23, 42, 0.7);
        color: #cbd5f5;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 8px 16px rgba(0, 0, 0, 0.45);
      }
      body.theme-dark .left-menu-item:hover .left-menu-icon {
        background: rgba(59, 130, 246, 0.2);
        color: #f8fafc;
      }
      body.theme-dark .left-menu-item.active .left-menu-icon {
        background: rgba(59, 130, 246, 0.3);
        color: #bfdbfe;
        box-shadow: 0 10px 20px rgba(59, 130, 246, 0.35);
      }
      body.theme-dark .tabs-bar {
        background: transparent;
        border-bottom: none;
        box-shadow: none;
        backdrop-filter: none;
      }
      body.theme-dark .sidebar-toggle-btn {
        background: rgba(15, 23, 42, 0.85);
        border-color: rgba(255, 255, 255, 0.08);
        color: #60a5fa;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.4);
      }
      body.theme-dark .sidebar-toggle-btn::before {
        background: rgba(2, 6, 23, 0.9);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.5);
      }
      body.theme-dark .sidebar-toggle-btn:hover {
        background: rgba(30, 41, 59, 0.9);
        color: #93c5fd;
      }
      body.theme-dark .app-root.sidebar-collapsed .sidebar-toggle-btn {
        background: linear-gradient(135deg, rgba(30, 58, 138, 0.9) 0%, rgba(37, 99, 235, 0.9) 100%);
        border-color: rgba(59, 130, 246, 0.5);
        color: #eff6ff;
      }
      body.theme-dark .workspace {
        background: transparent;
      }
      body.theme-dark .tab {
        color: #94a3b8;
      }
      body.theme-dark .tab:hover {
        background-color: rgba(30, 41, 59, 0.7);
        color: #f8fafc;
      }
      body.theme-dark .tab.active {
        background-color: rgba(2, 6, 23, 0.9);
        color: #93c5fd;
        border-color: rgba(59, 130, 246, 0.3);
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.5);
      }
      body.theme-dark .tab-toolbar,
      body.theme-dark .subtoolbar {
        background: transparent;
        border-bottom: none;
        box-shadow: none;
        backdrop-filter: none;
      }
      body.theme-dark .toolbar-button {
        background: rgba(15, 23, 42, 0.8);
        border-color: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
      }
      body.theme-dark .toolbar-button:hover {
        background: rgba(30, 41, 59, 0.9);
        border-color: rgba(96, 165, 250, 0.5);
      }
      body.theme-dark .data-area {
        background: transparent;
      }
      body.theme-dark .card,
      body.theme-dark .dialog-window,
      body.theme-dark .chart-card,
      body.theme-dark .table-card,
      body.theme-dark .home-card {
        background: rgba(2, 6, 23, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #e2e8f0;
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(18px);
      }
      body.theme-dark input,
      body.theme-dark select,
      body.theme-dark textarea {
        background: rgba(2, 6, 23, 0.7);
        border-color: rgba(255, 255, 255, 0.1);
        color: #f8fafc;
      }
      body.theme-dark input::placeholder,
      body.theme-dark textarea::placeholder {
        color: #94a3b8;
      }
      body.theme-dark .dialog-overlay {
        background: rgba(2, 6, 23, 0.85);
      }
      body.theme-dark .home-page-title,
      body.theme-dark .home-card-header,
      body.theme-dark .home-stat-value,
      body.theme-dark .home-list-item {
        color: #f8fafc;
      }
      body.theme-dark .home-card-subtitle,
      body.theme-dark .home-stat-label,
      body.theme-dark .home-list-meta,
      body.theme-dark .home-plan-day-title {
        color: #cbd5f5;
      }
      body.theme-dark .home-stat {
        border-color: rgba(255, 255, 255, 0.08);
        background: rgba(2, 6, 23, 0.8);
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
      }
      body.theme-dark .home-stat:hover {
        background: rgba(30, 41, 59, 0.7);
      }
      body.theme-dark .home-list-item {
        background: rgba(2, 6, 23, 0.7);
        border-color: rgba(255, 255, 255, 0.08);
      }
      body.theme-dark .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-color: rgba(59, 130, 246, 0.6);
        color: #ffffff;
        box-shadow: 0 12px 26px rgba(59, 130, 246, 0.35);
      }
      body.theme-dark .btn-ghost {
        background: rgba(15, 23, 42, 0.8);
        border-color: rgba(255, 255, 255, 0.08);
        color: #e2e8f0;
      }
      body.theme-dark .home-plan-pill {
        background: rgba(2, 6, 23, 0.75);
        border-color: rgba(255, 255, 255, 0.08);
      }
      body.theme-dark .home-plan-pill:hover {
        background: rgba(30, 41, 59, 0.7);
        box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.35);
      }
      body.theme-dark .home-plan-org,
      body.theme-dark .home-plan-item {
        color: #e2e8f0;
      }
      body.theme-dark .home-plan-meta {
        color: #cbd5f5;
      }
      body.theme-dark .home-plan-pill::before {
        background: #60a5fa;
      }
      body.theme-dark .home-stock-qty {
        background: rgba(2, 6, 23, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #cbd5f5;
      }
      body.theme-dark .home-period-picker {
        background: rgba(2, 6, 23, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(12px);
      }
      body.theme-dark .home-period-label {
        color: #cbd5f5;
      }
      body.theme-dark .date-chip {
        background: rgba(2, 6, 23, 0.7);
        border-color: transparent;
        color: #f8fafc;
      }
      body.theme-dark .date-chip input {
        background: transparent;
        color: #f8fafc;
      }
      body.theme-dark .date-chip:focus-within {
        border-color: rgba(96, 165, 250, 0.6);
        box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.5);
      }
      body.theme-dark .home-page-title {
        color: #ffffff;
        text-shadow: 0 6px 20px rgba(0,0,0,0.6);
      }
      body.theme-dark .home-plan-day-title {
        color: #93c5fd;
        background: rgba(2, 6, 23, 0.8);
        border-bottom: 1px solid rgba(96, 165, 250, 0.3);
      }
      body.theme-dark .home-plan-day {
        background: rgba(2, 6, 23, 0.7);
        border-color: rgba(255, 255, 255, 0.08);
      }
      body.theme-dark .home-plan-qty {
        background: rgba(59, 130, 246, 0.2);
        color: #dbeafe;
        border: 1px solid rgba(59,130,246,0.25);
      }
      body.theme-dark .home-plan-link {
        color: #93c5fd;
      }
      body.theme-dark .home-drive-search input {
        background: rgba(2, 6, 23, 0.7);
        border-color: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
      }
      body.theme-dark .home-drive-search input::placeholder {
        color: #94a3b8;
      }
      body.theme-dark ::selection {
        background: rgba(59, 130, 246, 0.35);
        color: #f8fafc;
      }
      body.theme-dark .home-drive-row {
        background: rgba(2,6,23,0.7);
        border: 1px solid rgba(255,255,255,0.08);
      }
      body.theme-dark .home-drive-name {
        color: #f8fafc;
      }
      body.theme-dark .home-drive-meta {
        color: #94a3b8;
      }
      body.theme-dark .home-drive-list .home-empty {
        color: #94a3b8;
      }
      body.theme-dark #homeStockMenu {
        background: rgba(2, 6, 23, 0.9);
        border-color: rgba(255,255,255,0.08);
        box-shadow: 0 16px 32px rgba(0,0,0,0.6);
      }
      body.theme-dark #homeStockMenu button {
        color: #e2e8f0;
      }
      body.theme-dark #homeStockMenu button:hover {
        background: rgba(30, 41, 59, 0.7);
      }
      body.theme-dark .home-drive-menu,
      body.theme-dark .home-drive-menu button {
        background: rgba(2, 6, 23, 0.9);
        border-color: rgba(255,255,255,0.08);
        color: #e2e8f0;
      }
      body.theme-dark .home-drive-menu button:hover {
        background: rgba(30, 41, 59, 0.7);
      }
      body.theme-dark .calendar-popup {
        background: #0b1220;
        border-color: rgba(255,255,255,0.08);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
        backdrop-filter: none;
      }
      body.theme-dark .calendar-nav-btn,
      body.theme-dark .calendar-footer-btn {
        background: rgba(2, 6, 23, 0.7);
        border-color: rgba(255,255,255,0.08);
        color: #f8fafc;
      }
      body.theme-dark .calendar-nav-btn:hover,
      body.theme-dark .calendar-footer-btn:hover {
        background: rgba(30, 41, 59, 0.7);
      }
      body.theme-dark .calendar-month-year,
      body.theme-dark .calendar-day-name {
        color: #e2e8f0;
      }
      body.theme-dark .calendar-day {
        color: #cbd5f5;
      }
      body.theme-dark .calendar-day:hover {
        background: rgba(59, 130, 246, 0.2);
      }
      body.theme-dark .calendar-day.today {
        background: rgba(59, 130, 246, 0.25);
        color: #f8fafc;
      }
      body.theme-dark .calendar-day.selected {
        background: #2563eb;
        color: #ffffff;
      }
      body.theme-dark .calendar-day.disabled {
        color: #64748b;
      }
      body.theme-dark #dataArea,
      body.theme-dark .contracts-host {
        background: transparent;
      }
      body.theme-dark .contracts-table thead th {
        background: rgba(15, 23, 42, 0.9);
        color: #94a3b8;
      }
      body.theme-dark .contracts-table tr.data-row {
        background: rgba(2, 6, 23, 0.85);
        box-shadow: 0 14px 28px rgba(0, 0, 0, 0.5);
      }
      body.theme-dark .contracts-table tr.data-row td {
        color: #e2e8f0;
        background: rgba(2, 6, 23, 0.85);
      }
      body.theme-dark .contracts-table tr.data-row:hover,
      body.theme-dark .contracts-table tr.data-row:hover td {
        background: rgba(30, 41, 59, 0.7);
      }
      body.theme-dark .contracts-table tr.data-row-selected,
      body.theme-dark .contracts-table tr.data-row-selected td {
        background: rgba(30, 58, 138, 0.28) !important;
      }
      body.theme-dark .contracts-planfact {
        background: rgba(2, 6, 23, 0.85);
        border-color: rgba(255, 255, 255, 0.08);
      }
      body.theme-dark .contracts-plan-row,
      body.theme-dark .contracts-plan-row .lbl,
      body.theme-dark .contracts-plan-row .val.plan,
      body.theme-dark .contracts-plan-row .val.fact {
        color: #e2e8f0;
      }
      body.theme-dark .contracts-badge.badge-done {
        background: rgba(34, 197, 94, 0.18);
        color: #86efac;
        border-color: rgba(34, 197, 94, 0.35);
      }
      body.theme-dark .contracts-badge.badge-progress {
        background: rgba(249, 115, 22, 0.18);
        color: #fdba74;
        border-color: rgba(249, 115, 22, 0.35);
      }
      body.theme-dark .contracts-badge.badge-missing {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
        border-color: rgba(239, 68, 68, 0.35);
      }
      body.theme-dark .contracts-actions .contracts-action-btn {
        color: #93c5fd;
      }
      body.theme-dark .contracts-action-btn:hover {
        background: rgba(59, 130, 246, 0.2);
      }
      body.theme-dark .contracts-import-progress {
        background: rgba(2, 6, 23, 0.9);
        border-color: rgba(255, 255, 255, 0.08);
        color: #e2e8f0;
      }
      body.theme-dark table.data-table th {
        color: #94a3b8;
      }
      body.theme-dark table.data-table tr.data-row-selected {
        outline-color: rgba(59, 130, 246, 0.5);
      }
      body.theme-dark .warehouse-table-header,
      body.theme-dark .warehouse-table-title {
        color: #e2e8f0;
      }
      body.theme-dark .warehouse-empty {
        background: rgba(2, 6, 23, 0.85);
        border-color: rgba(255, 255, 255, 0.08);
        color: #94a3b8;
      }
      body.theme-dark .contracts-toolbar__main,
      body.theme-dark .contracts-toolbar__sub,
      body.theme-dark .contracts-toolbar__title {
        color: #e2e8f0;
      }
      body.theme-dark .contracts-toolbar__icon {
        background: rgba(15, 23, 42, 0.8);
        color: #93c5fd;
        box-shadow: inset 0 0 0 1px rgba(96,165,250,0.25);
      }
      body.theme-dark .contracts-filters-card {
        background: rgba(2, 6, 23, 0.85);
        border-color: rgba(255, 255, 255, 0.08);
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.5);
      }
      body.theme-dark .contracts-filter .lbl {
        color: #94a3b8;
      }
      body.theme-dark .contracts-filter select,
      body.theme-dark .contracts-filter input[type="search"],
      body.theme-dark .contracts-filter input[type="text"] {
        background: rgba(2, 6, 23, 0.7);
        border-color: rgba(255, 255, 255, 0.1);
        color: #f8fafc;
      }
      body.theme-dark .contracts-filter select:focus,
      body.theme-dark .contracts-filter input[type="search"]:focus,
      body.theme-dark .contracts-filter input[type="text"]:focus {
        border-color: #60a5fa;
        box-shadow: 0 0 0 1px rgba(96,165,250,0.4);
      }
      body.theme-dark .contracts-clear-btn,
      body.theme-dark .contracts-sort-btn {
        background: rgba(15, 23, 42, 0.85);
        border-color: rgba(255, 255, 255, 0.08);
        color: #e2e8f0;
      }
      body.theme-dark .contracts-sort-btn.active {
        background: rgba(30, 58, 138, 0.35);
        border-color: rgba(96, 165, 250, 0.6);
        color: #e2e8f0;
      }
      body.theme-dark .contracts-toolbar .toolbar-button {
        background: rgba(15, 23, 42, 0.85);
        border-color: rgba(255, 255, 255, 0.08);
        color: #e2e8f0;
      }
      body.theme-dark .contracts-toolbar .toolbar-button.primary {
        background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
        border-color: rgba(59,130,246,0.6);
        color: #fff;
      }
      body.theme-dark .warehouse-toolbar,
      body.theme-dark .warehouse-subtoolbar,
      body.theme-dark .warehouse-section-title,
      body.theme-dark .warehouse-card-title,
      body.theme-dark .warehouse-qty {
        color: #e2e8f0;
      }
      body.theme-dark .warehouse-tab {
        background: rgba(2, 6, 23, 0.7);
        border-color: rgba(255, 255, 255, 0.08);
        color: #cbd5f5;
      }
      body.theme-dark .warehouse-tab-active {
        background: rgba(30, 58, 138, 0.35);
        color: #ffffff;
        border-color: rgba(96, 165, 250, 0.5);
      }
      body.theme-dark .warehouse-date-input,
      body.theme-dark .warehouse-search,
      body.theme-dark .warehouse-select,
      body.theme-dark .warehouse-refresh-btn,
      body.theme-dark .warehouse-sort-btn,
      body.theme-dark .warehouse-ghost-btn {
        background: rgba(2, 6, 23, 0.7);
        border-color: rgba(255, 255, 255, 0.08);
        color: #e2e8f0;
      }
      body.theme-dark .warehouse-date-input input,
      body.theme-dark .warehouse-search input {
        color: #f8fafc;
      }
      body.theme-dark .warehouse-primary-btn {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: #fff;
      }
      body.theme-dark .warehouse-stock-card,
      body.theme-dark .warehouse-table-card,
      body.theme-dark .warehouse-form-card {
        background: rgba(2, 6, 23, 0.8);
        border-color: rgba(255, 255, 255, 0.08);
        box-shadow: 0 16px 32px rgba(0,0,0,0.5);
      }
      body.theme-dark table.data-table tr.data-row {
        background: rgba(2, 6, 23, 0.75);
      }
      body.theme-dark table.data-table tr.data-row td {
        color: #e2e8f0;
      }
      body.theme-dark .warehouse-chip.positive {
        background: rgba(34,197,94,0.18);
        color: #86efac;
      }
      body.theme-dark .warehouse-chip.negative {
        background: rgba(239,68,68,0.18);
        color: #fca5a5;
      }
      body.theme-dark .analytics-toolbar-title,
      body.theme-dark .analytics-table-title,
      body.theme-dark .analytics-card .value {
        color: #e2e8f0;
      }
      body.theme-dark .analytics-tabs {
        background: rgba(2, 6, 23, 0.7);
        border-color: rgba(255, 255, 255, 0.08);
      }
      body.theme-dark .analytics-tab {
        color: #94a3b8;
      }
      body.theme-dark .analytics-tab.active {
        background: rgba(30, 58, 138, 0.35);
        color: #e2e8f0;
      }
      body.theme-dark .analytics-search input,
      body.theme-dark .analytics-date-picker,
      body.theme-dark .analytics-year-select {
        background: rgba(2, 6, 23, 0.7);
        border-color: rgba(255, 255, 255, 0.1);
        color: #f8fafc;
      }
      body.theme-dark .analytics-card,
      body.theme-dark .analytics-table-card,
      body.theme-dark .analytics-fact-card {
        background: rgba(2, 6, 23, 0.8);
        border-color: rgba(255, 255, 255, 0.08);
        box-shadow: 0 18px 36px rgba(0,0,0,0.5);
      }
      body.theme-dark .analytics-table tbody tr.analytics-row {
        background: rgba(2, 6, 23, 0.75);
      }
      body.theme-dark .analytics-table tbody tr.analytics-row td {
        color: #e2e8f0;
      }
      /* ===== Комбобокс (выпадающий список) ===== */
      .combo-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
      }
      .split-field { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .combo-input {
        width: 100%;
        box-sizing: border-box;
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--font-size-medium);
        border-radius: var(--border-radius);
        border: 1px solid var(--divider-color);
        background-color: var(--background-color);
        color: var(--on-surface-color);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      .combo-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
      }
      .combo-list {
        position: absolute;
        left: 0;
        right: 0;
        top: 100%;
        margin-top: var(--spacing-xs);
        background-color: var(--background-color);
        border: 1px solid var(--divider-color);
        box-shadow: var(--shadow-elevation-4);
        border-radius: var(--border-radius);
        max-height: 200px;
        overflow-y: auto;
        font-size: var(--font-size-medium);
        z-index: 15000;
        display: none;
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .combo-item {
        padding: var(--spacing-sm) var(--spacing-sm);
        cursor: pointer;
        transition: background-color 0.2s ease;
        border-bottom: 1px solid var(--divider-color);
      }
      .combo-item:last-child {
          border-bottom: none;
      }
      .combo-item:hover {
        background-color: #f1f3f4;
      }
      /* ===== Стили для красивых чекбоксов (повторяем из предыдущего обновления) ===== */
      input[type="checkbox"] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border: 2px solid var(--divider-color);
        border-radius: 3px;
        position: relative;
        cursor: pointer;
        background-color: var(--background-color);
        transition: all 0.12s ease;
      }
      input[type="checkbox"]:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }
      input[type="checkbox"]:checked::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 5px;
        width: 4px;
        height: 8px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
        opacity: 1;
      }
      input[type="checkbox"]:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.3);
      }
      /* ===== Стили для красивых радио-кнопок (на будущее) ===== */
      input[type="radio"] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border: 2px solid var(--divider-color);
        border-radius: 50%;
        position: relative;
        cursor: pointer;
        background-color: var(--background-color);
        transition: all 0.12s ease;
      }
      input[type="radio"]:checked {
        border-color: var(--primary-color);
      }
      input[type="radio"]:checked::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: var(--primary-color);
      }
      input[type="radio"]:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.3);
      }
      /* ===== Стили для красивых селектов (на будущее) ===== */
      select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--border-radius);
        border: 1px solid var(--divider-color);
        background-color: var(--background-color);
        color: var(--on-surface-color);
        font-size: var(--font-size-medium);
        cursor: pointer;
        background-image: url("image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%235f6368' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right var(--spacing-xs) center;
        background-size: 16px;
        padding-right: 28px;
      }
      select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
      }
      /* ===== Стили для красивых полей ввода ===== */
      input[type="text"],
      input[type="number"],
      input[type="search"],
      input[type="date"],
      input[type="time"],
      input[type="email"],
      input[type="password"],
      textarea {
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--border-radius);
        border: 1px solid var(--divider-color);
        background-color: var(--background-color);
        color: var(--on-surface-color);
        font-size: var(--font-size-medium);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        box-sizing: border-box;
      }
      input[type="text"]:focus,
      input[type="number"]:focus,
      input[type="search"]:focus,
      input[type="date"]:focus,
      input[type="time"]:focus,
      input[type="email"]:focus,
      input[type="password"]:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
      }
      textarea {
        resize: vertical;
        min-height: 40px;
        max-height: 200px;
      }
      /* ===== Стили для кнопок (повторяем и расширяем) ===== */
      button, .button-like {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--border-radius);
        border: 1px solid transparent;
        font-size: var(--font-size-medium);
        font-weight: var(--font-weight-medium);
        cursor: pointer;
        transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        min-height: 32px;
        text-align: center;
        box-sizing: border-box;
      }
      button.primary, .button-like.primary {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-dark);
      }
      button.primary:hover, .button-like.primary:hover {
        background-color: var(--primary-dark);
        box-shadow: var(--shadow-elevation-2);
      }
      button.secondary, .button-like.secondary {
        background-color: #f1f3f4;
        color: var(--on-surface-color);
        border-color: var(--divider-color);
      }
      button.secondary:hover, .button-like.secondary:hover {
        background-color: #e8eaed;
        box-shadow: var(--shadow-elevation-1);
      }
      button.outlined, .button-like.outlined {
        background-color: transparent;
        color: var(--primary-color);
        border-color: var(--primary-color);
      }
      button.outlined:hover, .button-like.outlined:hover {
        background-color: rgba(66, 133, 244, 0.1);
      }
      button.text, .button-like.text {
        background-color: transparent;
        color: var(--primary-color);
        border-color: transparent;
      }
      button.text:hover, .button-like.text:hover {
        background-color: rgba(66, 133, 244, 0.1);
      }
      button:disabled, .button-like:disabled {
        background-color: #f1f3f4;
        color: var(--on-surface-secondary-color);
        border-color: var(--divider-color);
        cursor: not-allowed;
      }
      /* ===== Стили для форм (повторяем из ui_contracts и ui_warehouse) ===== */
      .form-container {
        padding: var(--spacing-md);
        font-family: var(--font-family);
        background-color: var(--background-color);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-elevation-1);
        max-width: 800px;
        margin: 0 auto;
      }
      .form-container h3 {
        margin-top: 0;
        margin-bottom: var(--spacing-md);
        color: var(--on-surface-color);
        font-weight: var(--font-weight-bold);
        font-size: var(--font-size-large);
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
      }
      .form-field {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }
      .form-field label {
        font-size: var(--font-size-medium);
        color: var(--on-surface-color);
        font-weight: var(--font-weight-medium);
      }
      .form-field .combo-wrapper {
        position: relative;
      }
      .form-actions {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
        justify-content: flex-end;
      }
      /* ===== Стили для календаря ===== */
      .calendar-popup {
        position: absolute;
        z-index: 10000;
        background-color: var(--background-color);
        border: 1px solid var(--divider-color);
        box-shadow: var(--shadow-elevation-4);
        border-radius: var(--border-radius);
        padding: var(--spacing-sm);
        font-size: var(--font-size-medium);
        min-width: 320px;
        animation: fadeInUp 0.2s ease-out;
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      @keyframes gridMove {
        from { transform: perspective(900px) rotateX(55deg) translateY(120px); }
        to { transform: perspective(900px) rotateX(55deg) translateY(40px); }
      }
      @keyframes ringPulse {
        0%, 100% { transform: scale(1); opacity: 0.6; }
        50% { transform: scale(1.05); opacity: 0.9; }
      }
      @keyframes beamScan {
        0%, 100% { transform: translateY(-60px); opacity: 0.4; }
        50% { transform: translateY(60px); opacity: 1; }
      }
      @keyframes particleFloat {
        0%, 100% { transform: translateY(0); opacity: 0.4; }
        50% { transform: translateY(-12px); opacity: 1; }
      }
      @keyframes streamFill {
        0% { filter: brightness(0.7); transform: scaleX(0.5); transform-origin: left; }
        50% { filter: brightness(1.2); transform: scaleX(1); }
        100% { filter: brightness(0.7); transform: scaleX(0.6); transform-origin: right; }
      }
      @keyframes binaryStream {
        0% { transform: translateX(-20%); }
        100% { transform: translateX(20%); }
      }
      @keyframes eqBounce {
        0%, 100% { transform: scaleY(0.6); opacity: 0.6; }
        50% { transform: scaleY(1); opacity: 1; }
      }
      .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-sm);
      }
      .calendar-nav {
        display: flex;
        gap: var(--spacing-xs);
      }
      .calendar-nav-btn {
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--border-radius);
        border: 1px solid var(--divider-color);
        background-color: var(--background-color);
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        font-size: var(--font-size-large);
        line-height: 1;
      }
      .calendar-nav-btn:hover {
        background-color: #f1f3f4;
      }
      .calendar-month-year {
        font-weight: var(--font-weight-bold);
        color: var(--on-surface-color);
        font-size: var(--font-size-large);
      }
      .calendar-body {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-sm);
      }
      .calendar-day-name {
        font-size: var(--font-size-small);
        color: var(--on-surface-secondary-color);
        text-align: center;
        padding: var(--spacing-xs);
        font-weight: var(--font-weight-bold);
      }
      .calendar-day {
        padding: var(--spacing-xs);
        border-radius: var(--border-radius);
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 40px;
        font-size: var(--font-size-large);
        font-weight: var(--font-weight-medium);
      }
      .calendar-day:hover {
        background-color: #f1f3f4;
      }
      .calendar-day.today {
        background-color: var(--primary-light);
        color: var(--primary-dark);
        font-weight: var(--font-weight-bold);
      }
      .calendar-day.selected {
        background-color: var(--primary-color);
        color: white;
        font-weight: var(--font-weight-bold);
      }
      .calendar-day.disabled {
        color: var(--on-surface-secondary-color);
        opacity: 0.5;
        cursor: not-allowed;
      }
      .calendar-footer {
        display: flex;
        gap: var(--spacing-xs);
        justify-content: space-between;
        margin-top: var(--spacing-sm);
      }
      .calendar-footer-btn {
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--border-radius);
        border: 1px solid var(--divider-color);
        background-color: var(--background-color);
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-size: var(--font-size-medium);
        line-height: 1;
      }
      .calendar-footer-btn:hover {
        background-color: #f1f3f4;
      }
    </style>
    <script>
      (function () {
        var manifest = {
          name: 'ПП',
          short_name: 'ПП',
          start_url: '.',
          display: 'standalone',
          background_color: '#ffffff',
          theme_color: '#1A73E8'
        };
        var blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
        var url = URL.createObjectURL(blob);
        var link = document.createElement('link');
        link.rel = 'manifest';
        link.href = url;
        document.head.appendChild(link);

        if ('serviceWorker' in navigator) {
          var swCode = "self.addEventListener('install', e => self.skipWaiting());self.addEventListener('activate', e => self.clients.claim());self.addEventListener('fetch', () => {});";
          var swUrl = URL.createObjectURL(new Blob([swCode], { type: 'text/javascript' }));
          navigator.serviceWorker.register(swUrl).catch(function (err) {
            console.log('Service worker registration error', err);
          });
        }
      })();
    </script>
  </head>
  <body>
    <div id="appLoadingOverlay" class="app-loading-overlay">
      <div class="app-loading-bg"></div>
      <div class="app-loading-glow" aria-hidden="true"></div>
      <div class="app-loading-center">
        <svg class="app-loading-logo" viewBox="0 0 200 140" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="liquidMetal" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#9ca3af"/>
              <stop offset="50%" stop-color="#f8fafc"/>
              <stop offset="100%" stop-color="#9ca3af"/>
            </linearGradient>
          </defs>
          <path class="app-loading-p-left" d="M40 110 V30 H70 V110 M70 30 H40"/>
          <path class="app-loading-p-right" d="M130 110 V30 H160 V110 M160 30 H130"/>
          <path class="app-loading-smile" d="M50 120 C80 138, 120 138, 150 120"/>
        </svg>
        <div class="app-loading-title">ПРОСТЫЕ ПОСТАВКИ</div>
      </div>
      <div class="app-loading-line" aria-hidden="true"></div>
    </div>
    <div class="app-root">
      <div class="app-main">
        <!-- Левое меню -->
        <div class="left-menu">
          <div class="left-menu-logo">
            <div class="left-menu-badge left-menu-badge-smile" aria-hidden="true">
              <svg viewBox="0 0 48 48" aria-hidden="true">
                <path class="smile-eye" d="M10 34 V12 H18 V34 M18 12 H10" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                <path class="smile-eye right" d="M30 34 V12 H38 V34 M38 12 H30" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                <path class="smile-smile" d="M12 36 C18 42, 30 42, 36 36" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="left-menu-logo-text">
              <div class="title">ПростыеПоставки</div>
            </div>
          </div>
          <div class="left-menu-title">НАВИГАЦИЯ</div>
          <div class="left-menu-item" data-section="home">
            <span class="left-menu-icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 11.5L12 5l8 6.5"></path>
                <path d="M7.5 10.5V19h9v-8.5"></path>
              </svg>
            </span>
            <span class="left-menu-label">Главная</span>
          </div>
          <div class="left-menu-item" data-section="contracts">
            <span class="left-menu-icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect x="5" y="4" width="14" height="16" rx="3"></rect>
                <path d="M8 9h8"></path>
                <path d="M8 13h5"></path>
              </svg>
            </span>
            <span class="left-menu-label">Реестр контрактов</span>
          </div>
          <div class="left-menu-item" data-section="warehouse">
            <span class="left-menu-icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M3 9l9-4 9 4"></path>
                <path d="M5 9v9h14V9"></path>
                <path d="M9 18v-6h6v6"></path>
              </svg>
            </span>
            <span class="left-menu-label">Склад</span>
          </div>
          <div class="left-menu-item" data-section="analytics">
            <span class="left-menu-icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M5 19V9"></path>
                <path d="M12 19V5"></path>
                <path d="M19 19v-7"></path>
              </svg>
            </span>
            <span class="left-menu-label">Аналитика</span>
          </div>
          <div class="left-menu-item" data-section="commercials">
            <span class="left-menu-icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect x="4" y="7" width="16" height="12" rx="3"></rect>
                <path d="M8 7V5a4 4 0 0 1 8 0v2"></path>
                <path d="M4 12h16"></path>
              </svg>
            </span>
            <span class="left-menu-label">Коммерческие</span>
          </div>
          <div class="left-menu-item" data-section="pricelist">
            <span class="left-menu-icon">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M7 4h9a3 3 0 0 1 3 3v13H7a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3z"></path>
                <path d="M9 9h6"></path>
                <path d="M9 13h6"></path>
                <path d="M9 17h4"></path>
              </svg>
            </span>
            <span class="left-menu-label">Прайс-лист</span>
          </div>
          <div class="left-menu-footer">
            <button type="button" class="left-menu-archive-btn" id="downloadArchiveBtn" aria-label="Скачать архив Excel" title="Скачать архив Excel">
              <span class="archive-file-label">XLS</span>
              <span class="archive-download-hint">⬇</span>
            </button>
            <button type="button" class="left-menu-snow-btn" id="toggleSnowBtn" aria-pressed="false" aria-label="Снег">❄</button>
            <button type="button" class="theme-toggle-btn" id="toggleThemeBtn" aria-pressed="false" aria-label="Темная тема">🌙</button>
          </div>
        </div>
        <!-- Правая часть: вкладки + содержимое -->
        <div class="workspace">
          <div class="tabs-bar">
            <button type="button" id="toggleSidebarBtn" class="sidebar-toggle-btn" aria-label="Скрыть боковую панель"></button>
            <div id="tabs" class="tabs"></div>
          </div>
          <!-- Контейнер. В него JS будет "вставлять" набор: toolbar + subtoolbar + dataArea + bottom-panel для активной вкладки -->
          <div class="tab-content">
            <!-- Пусто: всё создаётся скриптом -->
          </div>
        </div>
      </div>
    </div>
    <!-- Модальный диалог приложения -->
    <div id="appDialogOverlay" class="dialog-overlay">
      <div class="dialog-window">
        <div id="appDialogTitle" class="dialog-title"></div>
        <div id="appDialogMessage" class="dialog-message"></div>
        <div id="appDialogButtons" class="dialog-buttons"></div>
      </div>
    </div>
    <script>
      (function () {
        /* ========= ТРЕКЕР ГОТОВНОСТИ МОДУЛЕЙ ========= */
        var AppModules = (function () {
          var readyFlags = {};
          var waiters = {};

          function markReady(name) {
            if (!name || readyFlags[name]) return;
            readyFlags[name] = true;
            if (waiters[name]) {
              waiters[name].forEach(function (resolve) { resolve(); });
              delete waiters[name];
            }
          }

          function waitReady(name) {
            if (readyFlags[name]) return Promise.resolve();
            return new Promise(function (resolve) {
              if (!waiters[name]) waiters[name] = [];
              waiters[name].push(resolve);
            });
          }

          function isReady(name) {
            return !!readyFlags[name];
          }

          return {
            markReady: markReady,
            waitReady: waitReady,
            isReady: isReady
          };
        })();
        window.AppModules = AppModules;

        var loadingOverlayEl = null;
        var loadingHintTimer = null;
        var loadingPercentTimer = null;
        var loadingHints = [
          'Настраиваемся на работу...',
          'Готовим контракты...',
          'Выставляем счета...',
          'Платим налоги...',
          'Выводим прибыль...',
          'Сверяем остатки по складу...',
          'Собираем подписантов...',
          'Печатаем акт о проделанной загрузке...',
          'Считаем бонусы бухгалтеру...',
          'Пересчитываем виртуальный НДС...'
        ];

        function showAppLoading() {
          if (!loadingOverlayEl) loadingOverlayEl = document.getElementById('appLoadingOverlay');
          if (loadingOverlayEl) loadingOverlayEl.classList.remove('hidden');
        }

        function hideAppLoading() {
          if (!loadingOverlayEl) loadingOverlayEl = document.getElementById('appLoadingOverlay');
          if (loadingOverlayEl) loadingOverlayEl.classList.add('hidden');
        }

        function shuffleHints(arr) {
          var a = arr.slice();
          for (var i = a.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var tmp = a[i];
            a[i] = a[j];
            a[j] = tmp;
          }
          return a;
        }

        function startLoadingHints() {
          var hintEl = document.getElementById('appLoadingHint');
          if (!hintEl) return;
          var hints = shuffleHints(loadingHints);
          var idx = 0;
          hintEl.textContent = hints[idx] || '';
          if (loadingHintTimer) clearInterval(loadingHintTimer);
          loadingHintTimer = setInterval(function () {
            idx = (idx + 1) % hints.length;
            hintEl.textContent = hints[idx] || '';
          }, 1400);
        }

        function stopLoadingHints() {
          if (loadingHintTimer) clearInterval(loadingHintTimer);
          loadingHintTimer = null;
        }

        function startLoadingPercent() {
          var percentEl = document.getElementById('appLoadingPercent');
          var chipEl = document.getElementById('appLoadingChipPercent');
          if (!percentEl && !chipEl) return;
          var tick = function () {
            var value = Math.floor(Math.random() * 100);
            var text = value + '%';
            if (percentEl) percentEl.textContent = text;
            if (chipEl) chipEl.textContent = text;
          };
          tick();
          if (loadingPercentTimer) clearInterval(loadingPercentTimer);
          loadingPercentTimer = setInterval(tick, 180);
        }

        function stopLoadingPercent() {
          if (loadingPercentTimer) clearInterval(loadingPercentTimer);
          loadingPercentTimer = null;
        }

        /* ========= ТАБЫ ========= */
        var tabs = []; // {id, module, title}
        var activeTabId = null;
        var nextTabId = 1;
        var moduleTitles = {
          home: 'Главная',
          contracts: 'Реестр контрактов',
          analytics: 'Аналитика',
          warehouse: 'Склад',
          commercials: 'Коммерческие',
          pricelist: 'Прайс-лист'
        };
        function highlightMenu(module) {
          var items = document.querySelectorAll('.left-menu-item');
          Array.prototype.forEach.call(items, function (it) {
            if (it.getAttribute('data-section') === module) it.classList.add('active');
            else it.classList.remove('active');
          });
        }
        // Хранилище DOM-состояний вкладок
        // tabId -> { toolbarEl, subToolbarEl, dataAreaEl, bottomPanelEl, scrollTop }
        var tabDomStates = {};
        var contentContainer = null;
        var bottomPanelTemplateHtml =
          '<div class="chart-block">' +
            '<div id="bottomPanelTitle1" class="chart-title">Панель 1</div>' +
            '<div style="font-size:var(--font-size-small);color:var(--on-surface-secondary-color);">Пусто</div>' +
          '</div>' +
          '<div class="chart-block">' +
            '<div id="bottomPanelTitle2" class="chart-title">Панель 2</div>' +
            '<div style="font-size:var(--font-size-small);color:var(--on-surface-secondary-color);">Пусто</div>' +
          '</div>';
        function openModuleTab(module) {
          // ищем уже открытую вкладку
          var existing = tabs.find(function (t) { return t.module === module; });
          if (existing) {
            setActiveTab(existing.id);
            return;
          }
          // создаём новую
          var id = 'tab_' + (nextTabId++);
          var title = moduleTitles[module] || module;
          tabs.push({ id: id, module: module, title: title });
          setActiveTab(id);
        }
        function setActiveTab(tabId) {
          if (activeTabId === tabId) return;
          // ---- 1. Сохраняем DOM текущей вкладки (если был активный таб) ----
          if (activeTabId && contentContainer) {
            var curToolbar = document.getElementById('tabToolbar');
            var curSub = document.getElementById('subToolbar');
            var curData = document.getElementById('dataArea');
            var curBottom = contentContainer.querySelector('.bottom-panel');
            if (curToolbar && curSub && curData && curBottom) {
              var state = {
                toolbarEl: curToolbar,
                subToolbarEl: curSub,
                dataAreaEl: curData,
                bottomPanelEl: curBottom,
                scrollTop: curData.scrollTop || 0
              };
              tabDomStates[activeTabId] = state;
              // вынимаем узлы из DOM (но не уничтожаем)
              contentContainer.removeChild(curToolbar);
              contentContainer.removeChild(curSub);
              contentContainer.removeChild(curData);
              contentContainer.removeChild(curBottom);
            }
          }
          activeTabId = tabId;
          window.__activeTabId = activeTabId;
          renderTabs();
          var tab = tabs.find(function (t) { return t.id === tabId; });
          window.__activeModule = tab ? tab.module : null;
          highlightMenu(window.__activeModule);
          if (!tab) {
            setToolbarContent('');
            setSubtoolbarContent('');
            setDataAreaContent('');
            return;
          }
          // ---- 2. Восстанавливаем или создаём DOM для новой вкладки ----
          var domState = tabDomStates[tabId];
          if (contentContainer) {
            if (domState) {
              // Вкладка уже открывалась раньше — просто возвращаем её DOM
              contentContainer.appendChild(domState.toolbarEl);
              contentContainer.appendChild(domState.subToolbarEl);
              contentContainer.appendChild(domState.dataAreaEl);
              contentContainer.appendChild(domState.bottomPanelEl);
              // восстановим скролл
              if (domState.dataAreaEl) {
                domState.dataAreaEl.scrollTop = domState.scrollTop || 0;
              }
            } else {
              // Первая активация вкладки — создаём "скелет" элементов
              var toolbarElNew = document.createElement('div');
              toolbarElNew.id = 'tabToolbar';
              toolbarElNew.className = 'tab-toolbar';
              var subElNew = document.createElement('div');
              subElNew.id = 'subToolbar';
              subElNew.className = 'subtoolbar';
              var dataElNew = document.createElement('div');
              dataElNew.id = 'dataArea';
              dataElNew.className = 'data-area';
              var bottomElNew = document.createElement('div');
              bottomElNew.className = 'bottom-panel';
              bottomElNew.innerHTML = bottomPanelTemplateHtml;
              contentContainer.appendChild(toolbarElNew);
              contentContainer.appendChild(subElNew);
              contentContainer.appendChild(dataElNew);
              contentContainer.appendChild(bottomElNew);
              // ---- 3. Первый раз открыли модуль — вызываем его load() ----
              if (tab.module === 'home' && typeof UIHome !== 'undefined') {
                UIHome.load();
              } else if (tab.module === 'contracts' && typeof UIContracts !== 'undefined') {
                UIContracts.load();
              } else if (tab.module === 'analytics' && typeof UIAnalytics !== 'undefined') {
                UIAnalytics.load();
              } else if (tab.module === 'warehouse' && typeof UIWarehouse !== 'undefined') {
                UIWarehouse.load();
              } else if (tab.module === 'commercials' && typeof UICommercials !== 'undefined') {
                UICommercials.load();
              } else if (tab.module === 'pricelist' && typeof UIPricelist !== 'undefined') {
                UIPricelist.load();
              }
            }
            if (tab.module === 'home' && typeof UIHome !== 'undefined' && UIHome.onResume) {
              UIHome.onResume();
            } else if (tab.module === 'contracts' && typeof UIContracts !== 'undefined' && UIContracts.onResume) {
              UIContracts.onResume();
            } else if (tab.module === 'analytics' && typeof UIAnalytics !== 'undefined' && UIAnalytics.onResume) {
              UIAnalytics.onResume();
            } else if (tab.module === 'warehouse' && typeof UIWarehouse !== 'undefined' && UIWarehouse.onResume) {
              UIWarehouse.onResume();
            } else if (tab.module === 'commercials' && typeof UICommercials !== 'undefined' && UICommercials.onResume) {
              UICommercials.onResume();
            } else if (tab.module === 'pricelist' && typeof UIPricelist !== 'undefined' && UIPricelist.onResume) {
              UIPricelist.onResume();
            }
          }
        }
        function createTabGuard(module) {
          var tabId = activeTabId;
          var moduleName = module;
          return {
            isActive: function () {
              return window.__activeModule === moduleName && activeTabId === tabId;
            }
          };
        }
        window.createTabGuard = createTabGuard;
        function renderTabs() {
          var tabsDiv = document.getElementById('tabs');
          if (!tabsDiv) return;
          var html = '';
          tabs.forEach(function (t) {
            html += '<div class="tab' + (t.id === activeTabId ? ' active' : '') + '" data-id="' + t.id + '">' +
              '<span>' + t.title + '</span>' +
              '<span class="tab-close" data-close="' + t.id + '">×</span>' +
              '</div>';
          });
          tabsDiv.innerHTML = html;
          Array.prototype.forEach.call(
            tabsDiv.querySelectorAll('.tab'),
            function (el) {
              el.addEventListener('click', function (e) {
                var closeId = e.target.getAttribute('data-close');
                if (closeId) {
                  closeTab(closeId);
                  e.stopPropagation();
                  return;
                }
                var id = el.getAttribute('data-id');
                setActiveTab(id);
              });
            }
          );
        }
        function closeTab(tabId) {
          var idx = tabs.findIndex(function (t) { return t.id === tabId; });
          if (idx === -1) return;
          // удаляем сохранённое DOM-состояние вкладки
          delete tabDomStates[tabId];
          tabs.splice(idx, 1);
          if (activeTabId === tabId) {
            if (tabs.length > 0) {
              setActiveTab(tabs[tabs.length - 1].id);
            } else {
              activeTabId = null;
              renderTabs();
              setToolbarContent('');
              setSubtoolbarContent('');
              setDataAreaContent('');
            }
          } else {
            renderTabs();
          }
        }
        window.openModuleTab = openModuleTab;
        /* ========= ХЕЛПЕРЫ ДЛЯ КОНТЕНТА ВКЛАДКИ ========= */
        function setToolbarContent(html) {
          var el = document.getElementById('tabToolbar');
          if (el) el.innerHTML = html;
        }
        function setSubtoolbarContent(html) {
          var el = document.getElementById('subToolbar');
          if (el) el.innerHTML = html;
        }
        function setDataAreaContent(html) {
          var el = document.getElementById('dataArea');
          if (el) {
            el.innerHTML = html;
            // при явной смене контента сбрасываем скролл
            el.scrollTop = 0;
          }
        }
        function setBottomPanelTitles(t1, t2) {
          var el1 = document.getElementById('bottomPanelTitle1');
          var el2 = document.getElementById('bottomPanelTitle2');
          if (el1) el1.textContent = t1 || '';
          if (el2) el2.textContent = t2 || '';
        }
        window.setToolbarContent      = setToolbarContent;
        window.setSubtoolbarContent   = setSubtoolbarContent;
        window.setDataAreaContent     = setDataAreaContent;
        window.setBottomPanelTitles   = setBottomPanelTitles;
        /* ========= РЕЗАЙЗ КОЛОНОК ========= */
        function makeTableResizable(table) {
          if (!table) return;
          var ths = table.querySelectorAll('th');
          Array.prototype.forEach.call(ths, function (th) {
            var resizer = th.querySelector('.col-resizer');
            if (!resizer) {
              resizer = document.createElement('div');
              resizer.className = 'col-resizer';
              th.appendChild(resizer);
            }
            var startX, startWidth;
            resizer.onmousedown = function (e) {
              e.preventDefault();
              startX = e.pageX;
              startWidth = th.offsetWidth;
              document.addEventListener('mousemove', onMouseMove);
              document.addEventListener('mouseup', onMouseUp);
            };
            function onMouseMove(e) {
              var diff = e.pageX - startX;
              var newWidth = startWidth + diff;
              if (newWidth < 40) newWidth = 40;
              th.style.width = newWidth + 'px';
            }
            function onMouseUp() {
              document.removeEventListener('mousemove', onMouseMove);
              document.removeEventListener('mouseup', onMouseUp);
            }
          });
        }
        window.makeTableResizable = makeTableResizable;
        /* ========= ОБЩИЙ МЕНЕДЖЕР СТРОК ========= */
        var RowSelection = (function () {
          var currentRows = [];
          var selectedIds = new Set();
          var currentOptions = null;
          var menuEl = null;
          var outsideHandlerBound = false;
          function attach(table, options) {
            if (!table) return;
            currentOptions = options || {};
            currentRows = Array.from(
              table.querySelectorAll(options.rowSelector || 'tr.data-row')
            );
            selectedIds.clear();
            currentRows.forEach(function (r) {
              r.classList.remove('data-row-selected');
            });
            ensureMenu();
            rebuildMenu();
            bindOutsideClear();
            currentRows.forEach(function (row) {
              var id = row.getAttribute(options.idAttr || 'data-id');
              if (!id) return;
              // одиночный клик: выбор/мультивыбор
              row.addEventListener('click', function (e) {
                if (e.detail > 1) return; // не мешаем dblclick
                if (e.ctrlKey || e.metaKey) {
                  toggleSelection(row, id);
                } else {
                  clearSelection();
                  selectRow(row, id);
                }
              });
              // двойной клик: редактирование
              row.addEventListener('dblclick', function (e) {
                e.preventDefault();
                if (currentOptions.onEdit) {
                  currentOptions.onEdit(id);
                }
              });
              // ПКМ: контекстное меню
              row.addEventListener('contextmenu', function (e) {
                e.preventDefault();
                if (e.ctrlKey || e.metaKey) {
                  toggleSelection(row, id);
                } else if (!selectedIds.has(id)) {
                  clearSelection();
                  selectRow(row, id);
                }
                if (selectedIds.size === 0) {
                  selectRow(row, id);
                }
                openMenu(e.pageX, e.pageY);
              });
            });
          }
          function selectRow(row, id) {
            row.classList.add('data-row-selected');
            selectedIds.add(id);
          }
          function clearSelection() {
            currentRows.forEach(function (r) {
              r.classList.remove('data-row-selected');
            });
            selectedIds.clear();
          }
          function toggleSelection(row, id) {
            if (selectedIds.has(id)) {
              selectedIds.delete(id);
              row.classList.remove('data-row-selected');
            } else {
              selectedIds.add(id);
              row.classList.add('data-row-selected');
            }
          }
          function onOutsideMouseDown(e) {
            if (!currentRows || !currentRows.length) return;
            if (menuEl && menuEl.contains(e.target)) return;
            var selector = (currentOptions && currentOptions.rowSelector) || 'tr.data-row';
            if (e.target.closest(selector)) return;
            clearSelection();
            hideMenu();
          }
          function bindOutsideClear() {
            if (outsideHandlerBound) return;
            document.addEventListener('mousedown', onOutsideMouseDown);
            outsideHandlerBound = true;
          }
          /* ===== контекстное меню ===== */
          function ensureMenu() {
            if (menuEl) return;
            menuEl = document.createElement('div');
            menuEl.className = 'row-context-menu';
            menuEl.style.display = 'none';
            document.body.appendChild(menuEl);
            menuEl.addEventListener('click', function (e) {
              var action = e.target.getAttribute('data-action');
              if (!action) return;
              var ids = Array.from(selectedIds);
              hideMenu();
              if (!currentOptions) return;
              if (action === 'moves') {
                // Посмотреть движения товара
                if (!currentOptions.onViewMoves) return;
                currentOptions.onViewMoves(ids, currentRows);
              } else if (action === 'edit') {
                if (!currentOptions.onEdit) return;
                if (ids.length !== 1) {
                  AppDialog.alert('Для редактирования выберите одну строку.', 'Редактирование');
                  return;
                }
                currentOptions.onEdit(ids[0]);
              } else if (action === 'delete') {
                if (!currentOptions.onDelete) return;
                if (!ids.length) return;
                currentOptions.onDelete(ids);
              } else if (currentOptions.onMenu) {
                currentOptions.onMenu(action, ids, currentRows);
              }
            });
            document.addEventListener('click', function () {
              hideMenu();
            });
            document.addEventListener('scroll', function () {
              hideMenu();
            }, true);
          }
          function rebuildMenu() {
            if (!menuEl) return;
            var html = '';
            if (currentOptions && currentOptions.customMenu && currentOptions.customMenu.length) {
              currentOptions.customMenu.forEach(function (item) {
                if (!item || !item.action || !item.label) return;
                var cls = 'row-context-item';
                if (item.danger) cls += ' row-context-item-danger';
                html += '<div class="' + cls + '" data-action="' + item.action + '">' + item.label + '</div>';
              });
            }
            // «Посмотреть движения товара» показываем только там, где есть обработчик
            if (currentOptions && currentOptions.onViewMoves) {
              html += '<div class="row-context-item" data-action="moves">Посмотреть движения товара</div>';
            }
            // Редактировать — если есть обработчик
            if (currentOptions && currentOptions.onEdit) {
              html += '<div class="row-context-item" data-action="edit">Редактировать</div>';
            }
            // Удалить — если есть обработчик
            if (currentOptions && currentOptions.onDelete) {
              html += '<div class="row-context-item row-context-item-danger" data-action="delete">Удалить</div>';
            }
            menuEl.innerHTML = html;
          }
          function openMenu(x, y) {
            if (!menuEl) return;
            // если нет ни одного пункта — не показываем меню
            if (!menuEl.innerHTML.trim()) return;
            menuEl.style.left = x + 'px';
            menuEl.style.top  = y + 'px';
            menuEl.style.display = 'block';
          }
          function hideMenu() {
            if (menuEl) menuEl.style.display = 'none';
          }
          return {
            attach: attach
          };
        })();
        window.RowSelection = RowSelection;
        /* ========= МОДАЛЬНЫЕ ОКНА ПРИЛОЖЕНИЯ ========= */
        var AppDialog = (function () {
          var overlay, titleEl, msgEl, buttonsEl;
          function init() {
            if (overlay) return;
            overlay   = document.getElementById('appDialogOverlay');
            titleEl   = document.getElementById('appDialogTitle');
            msgEl     = document.getElementById('appDialogMessage');
            buttonsEl = document.getElementById('appDialogButtons');
          }
          function show() {
            init();
            overlay.style.display = 'flex';
          }
          function hide() {
            if (!overlay) return;
            overlay.style.display = 'none';
            buttonsEl.innerHTML = '';
          }
          function alert(message, title, onClose) {
            init();
            titleEl.textContent = title || 'Сообщение';
            msgEl.textContent   = message || '';
            buttonsEl.innerHTML = '';
            var btnOk = document.createElement('button');
            btnOk.className = 'dialog-btn dialog-btn-primary';
            btnOk.textContent = 'OK';
            btnOk.onclick = function () {
              hide();
              if (onClose) onClose();
            };
            buttonsEl.appendChild(btnOk);
            show();
          }
          function confirm(message, onYes, onNo, title) {
            init();
            titleEl.textContent = title || 'Подтверждение';
            msgEl.textContent   = message || '';
            buttonsEl.innerHTML = '';
            var btnNo = document.createElement('button');
            btnNo.className = 'dialog-btn dialog-btn-secondary';
            btnNo.textContent = 'Отмена';
            btnNo.onclick = function () {
              hide();
              if (onNo) onNo();
            };
            var btnYes = document.createElement('button');
            btnYes.className = 'dialog-btn dialog-btn-primary';
            btnYes.textContent = 'Да';
            btnYes.onclick = function () {
              hide();
              if (onYes) onYes();
            };
            buttonsEl.appendChild(btnNo);
            buttonsEl.appendChild(btnYes);
            show();
          }
          return {
            alert: alert,
            confirm: confirm
          };
        })();
        window.AppDialog = AppDialog;

        /* ========= СНЕГ ========= */
        var Snowfall = (function () {
          var container = null;
          var timer = null;
          var enabled = false;
          var maxFlakes = 80;

          function ensureContainer() {
            if (container && document.body.contains(container)) return container;
            container = document.createElement('div');
            container.className = 'snow-container';
            document.body.appendChild(container);
            return container;
          }

          function spawnFlake() {
            if (!enabled) return;
            var wrap = ensureContainer();
            if (!wrap) return;

            var flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.textContent = '❄';

            var size = 8 + Math.random() * 8;
            var left = Math.random() * 100;
            var drift = (Math.random() * 60) - 30;
            var duration = 8 + Math.random() * 8;
            var delay = Math.random() * 4;
            flake.style.fontSize = size + 'px';
            flake.style.left = left + '%';
            flake.style.opacity = (0.35 + Math.random() * 0.35).toFixed(2);
            flake.style.setProperty('--x-start', '0px');
            flake.style.setProperty('--x-end', drift + 'px');
            flake.style.animationDuration = duration + 's';
            flake.style.animationDelay = delay + 's';

            wrap.appendChild(flake);
            setTimeout(function () {
              if (flake && flake.parentNode) flake.parentNode.removeChild(flake);
            }, (duration + delay) * 1000);

            // cull excess flakes
            if (wrap.children.length > maxFlakes) {
              wrap.removeChild(wrap.firstChild);
            }
          }

          function start() {
            if (enabled) return;
            enabled = true;
            ensureContainer();
            for (var i = 0; i < 22; i++) spawnFlake();
            timer = setInterval(spawnFlake, 450);
          }

          function stop() {
            enabled = false;
            if (timer) clearInterval(timer);
            timer = null;
            if (container && container.parentNode) {
              container.parentNode.removeChild(container);
            }
            container = null;
          }

          function toggle() {
            if (enabled) stop();
            else start();
            return enabled;
          }

          function isEnabled() { return enabled; }

          return {
            toggle: toggle,
            isEnabled: isEnabled
          };
        })();

        /* ========= ПРЕЛОАДЕР ПРИЛОЖЕНИЯ ========= */
        var preloaderModules = ['contracts', 'commercials', 'warehouse', 'pricelist', 'analytics'];

        function bindLeftMenuClicks() {
          var items = document.querySelectorAll('.left-menu-item');
          Array.prototype.forEach.call(items, function (item) {
            item.addEventListener('click', function () {
              var section = item.getAttribute('data-section');
              highlightMenu(section);
              openModuleTab(section);
            });
          });
        }

        var themeStorageKey = 'app-theme';

        function applyTheme(theme) {
          var isDark = theme === 'dark';
          document.body.classList.toggle('theme-dark', isDark);
          var btn = document.getElementById('toggleThemeBtn');
          if (btn) {
            btn.textContent = isDark ? '☀' : '🌙';
            btn.setAttribute('aria-label', isDark ? 'Светлая тема' : 'Темная тема');
            btn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
          }
          var meta = document.querySelector('meta[name="theme-color"]');
          if (meta) meta.setAttribute('content', isDark ? '#0f172a' : '#1A73E8');
        }

        function bindThemeToggle() {
          var btn = document.getElementById('toggleThemeBtn');
          if (!btn) return;
          var stored = localStorage.getItem(themeStorageKey);
          var initial = stored || 'light';
          applyTheme(initial);
          btn.addEventListener('click', function () {
            var next = document.body.classList.contains('theme-dark') ? 'light' : 'dark';
            localStorage.setItem(themeStorageKey, next);
            applyTheme(next);
          });
        }

        function bindSnowToggle() {
          var btn = document.getElementById('toggleSnowBtn');
          if (!btn) return;
          var updateText = function () {
            btn.setAttribute('aria-pressed', Snowfall.isEnabled() ? 'true' : 'false');
          };
          btn.addEventListener('click', function () {
            Snowfall.toggle();
            updateText();
          });
          updateText();
        }

        function bindSidebarToggle() {
          var btn = document.getElementById('toggleSidebarBtn');
          var appRoot = document.querySelector('.app-root');
          if (!btn || !appRoot) return;
          var updateLabel = function () {
            var collapsed = appRoot.classList.contains('sidebar-collapsed');
            btn.setAttribute('aria-label', collapsed ? 'Показать боковую панель' : 'Скрыть боковую панель');
          };
          btn.addEventListener('click', function () {
            appRoot.classList.toggle('sidebar-collapsed');
            updateLabel();
          });
          updateLabel();
        }

        function bindArchiveDownload() {
          var btn = document.getElementById('downloadArchiveBtn');
          if (!btn || typeof google === 'undefined' || !google.script || !google.script.run) return;
          btn.addEventListener('click', function () {
            if (btn.disabled) return;
            btn.disabled = true;
            google.script.run
              .withSuccessHandler(function (res) {
                btn.disabled = false;
                if (!res || !res.success || !res.data) {
                  var errorText = (res && res.error) ? res.error : 'Не удалось подготовить архив.';
                  AppDialog.alert(errorText, 'Скачивание');
                  return;
                }
                if (res.data.downloadUrl) {
                  var linkFallback = document.createElement('a');
                  linkFallback.href = res.data.downloadUrl;
                  linkFallback.target = '_blank';
                  linkFallback.rel = 'noopener';
                  document.body.appendChild(linkFallback);
                  linkFallback.click();
                  document.body.removeChild(linkFallback);
                  return;
                }
                AppDialog.alert('Не удалось подготовить архив.', 'Скачивание');
              })
              .withFailureHandler(function (err) {
                btn.disabled = false;
                AppDialog.alert('Ошибка скачивания: ' + (err && err.message ? err.message : err), 'Скачивание');
              })
              .appBackend({ module: 'archive', action: 'downloadProjectArchive', payload: {} });
          });
        }

        function waitWithTimeout(promise, ms) {
          var fallback = new Promise(function (resolve) { setTimeout(resolve, ms); });
          return Promise.race([promise, fallback]);
        }

        function preloadModule(module) {
          try {
            if (module === 'contracts'   && typeof UIContracts   !== 'undefined' && UIContracts.preload)   return UIContracts.preload();
            if (module === 'commercials' && typeof UICommercials !== 'undefined' && UICommercials.preload) return UICommercials.preload();
            if (module === 'warehouse'   && typeof UIWarehouse   !== 'undefined' && UIWarehouse.preload)   return UIWarehouse.preload();
            if (module === 'pricelist'   && typeof UIPricelist   !== 'undefined' && UIPricelist.preload)   return UIPricelist.preload();
            if (module === 'analytics'   && typeof UIAnalytics   !== 'undefined' && UIAnalytics.preload)   return UIAnalytics.preload();
          } catch (e) {}
          return Promise.resolve();
        }

        function startInitialLoad() {
          showAppLoading();
          startLoadingHints();
          startLoadingPercent();

          openModuleTab('home');

          waitWithTimeout(AppModules.waitReady('home'), 6000)
            .catch(function () {})
            .then(function () {
              stopLoadingHints();
              stopLoadingPercent();
              hideAppLoading();
              highlightMenu('home');
            });

          preloaderModules.forEach(function (module) {
            Promise.resolve()
              .then(function () { return preloadModule(module); })
              .then(function () { return waitWithTimeout(AppModules.waitReady(module), 12000); })
              .catch(function () { return Promise.resolve(); });
          });
        }
        /* ========= ИНИЦИАЛИЗАЦИЯ ========= */
        window.onload = function () {
          // контейнер, в котором живут тулбар, сабтулбар, dataArea и bottom-panel
          contentContainer = document.querySelector('.tab-content');
          bindLeftMenuClicks();
          bindThemeToggle();
          bindSnowToggle();
          bindSidebarToggle();
          bindArchiveDownload();
          startInitialLoad();
        };
        /* ========= НОВЫЙ КАЛЕНДАРЬ ======== */
        // Глобальные переменные для календаря
        var dpOverlay = null;
        var dpInput = null;
        var dpMonth = null;
        var dpYear = null;
        // Инициализация календаря
        function ensureDatePickerOverlay() {
          if (dpOverlay) return;
          dpOverlay = document.createElement('div');
          dpOverlay.className = 'calendar-popup';
          dpOverlay.style.display = 'none';
          document.body.appendChild(dpOverlay);
          // Закрытие при клике вне
          document.addEventListener('mousedown', function (e) {
            if (!dpOverlay || dpOverlay.style.display === 'none') return;
            if (dpOverlay.contains(e.target) || (dpInput && dpInput.contains(e.target))) return;
            hideDatePicker();
          });
        }
        function triggerDateInputChange() {
          if (!dpInput) return;
          var evInput = new Event('input', { bubbles: true });
          var evChange = new Event('change', { bubbles: true });
          dpInput.dispatchEvent(evInput);
          dpInput.dispatchEvent(evChange);
        }
        // Показать календарь
        function getScrollParent(el) {
          var parent = el ? el.parentElement : null;
          while (parent && parent !== document.body) {
            var style = window.getComputedStyle(parent);
            var overflow = (style.overflow + style.overflowY + style.overflowX);
            if (/auto|scroll/i.test(overflow)) return parent;
            parent = parent.parentElement;
          }
          return document.body;
        }

        function ensureOverlayVisible(overlay, anchor) {
          if (!overlay) return;
          var margin = 12;
          var rect = overlay.getBoundingClientRect();
          var container = anchor ? getScrollParent(anchor) : document.body;
          if (container === document.body) {
            if (rect.bottom > window.innerHeight) {
              window.scrollBy(0, rect.bottom - window.innerHeight + margin);
            }
            if (rect.top < 0) {
              window.scrollBy(0, rect.top - margin);
            }
            return;
          }
          var contRect = container.getBoundingClientRect();
          var top = rect.top - contRect.top;
          var bottom = rect.bottom - contRect.top;
          if (bottom > container.clientHeight) {
            container.scrollTop += bottom - container.clientHeight + margin;
          }
          if (top < 0) {
            container.scrollTop += top - margin;
          }
        }

        function showDatePickerFor(input) {
          ensureDatePickerOverlay();
          dpInput = input;
          // Парсим текущую дату из поля
          var base = ruDateToDate(input.value) || new Date();
          dpMonth = base.getMonth();
          dpYear = base.getFullYear();
          renderDatePicker(base);

          if (dpOverlay.parentNode !== document.body) document.body.appendChild(dpOverlay);
          dpOverlay.style.position = 'fixed';
          dpOverlay.style.display = 'block';

          var rect = input.getBoundingClientRect();
          var overlayRect = dpOverlay.getBoundingClientRect();
          var margin = 8;

          var left = rect.left;
          var top = rect.bottom + 6;

          if (left + overlayRect.width > window.innerWidth - margin) {
            left = window.innerWidth - overlayRect.width - margin;
          }
          if (left < margin) left = margin;

          dpOverlay.style.left = left + 'px';
          dpOverlay.style.top = top + 'px';
          ensureOverlayVisible(dpOverlay, input);
        }
        // Скрыть календарь
        function hideDatePicker() {
          if (dpOverlay) dpOverlay.style.display = 'none';
          dpInput = null;
        }
        // Отрендерить календарь
        function renderDatePicker(selectedDate) {
          if (!dpOverlay || dpMonth === null || dpMonth === undefined) return;
          var months = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
          var week   = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
          var firstDay    = new Date(dpYear, dpMonth, 1);
          var start       = (firstDay.getDay() + 6) % 7; // Понедельник - 0
          var daysInMonth = new Date(dpYear, dpMonth + 1, 0).getDate();
          var selIso = selectedDate ? isoFromYMD(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate()) : '';
          var selRu  = selIso ? formatDateRu(selIso) : '';
          var today       = new Date();
          var todayIso    = isoFromYMD(today.getFullYear(), today.getMonth(), today.getDate());
          var todayRu     = formatDateRu(todayIso);
          var html = '';
          // Заголовок с навигацией
          html += '<div class="calendar-header">';
          html += '<div class="calendar-nav">';
          html += '<button class="calendar-nav-btn" data-dp-prev>‹</button>';
          html += '<button class="calendar-nav-btn" data-dp-next>›</button>';
          html += '</div>';
          html += '<div class="calendar-month-year">' + months[dpMonth] + ' ' + dpYear + '</div>';
          html += '</div>';
          // Дни недели
          html += '<div class="calendar-body">';
          for (var i = 0; i < 7; i++) {
            html += '<div class="calendar-day-name">' + week[i] + '</div>';
          }
          // Дни месяца
          var day = 1;
          for (var r = 0; r < 6; r++) {
            for (var c = 0; c < 7; c++) {
              var cell = '&nbsp;';
              if (!(r === 0 && c < start) && day <= daysInMonth) {
                var iso = isoFromYMD(dpYear, dpMonth, day);
                var ru  = formatDateRu(iso);
                var isToday = (ru === todayRu);
                var isSelected = (ru === selRu);
                var classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';
                cell = '<div class="' + classes + '" data-dp-day="' + ru + '">' + day + '</div>';
                day++;
              }
              html += '<div>' + cell + '</div>';
            }
            if (day > daysInMonth) break;
          }
          html += '</div>';
          // Футер с кнопками
          html += '<div class="calendar-footer">';
          html += '<button class="calendar-footer-btn" data-dp-clear>Очистить дату</button>';
          html += '<button class="calendar-footer-btn" data-dp-today>Сегодня</button>';
          html += '</div>';
          dpOverlay.innerHTML = html;
          // Обработчики событий
          dpOverlay.querySelector('[data-dp-prev]').onclick = function () {
            dpMonth--;
            if (dpMonth < 0) {
              dpMonth = 11;
              dpYear--;
            }
            renderDatePicker(selectedDate);
          };
          dpOverlay.querySelector('[data-dp-next]').onclick = function () {
            dpMonth++;
            if (dpMonth > 11) {
              dpMonth = 0;
              dpYear++;
            }
            renderDatePicker(selectedDate);
          };
          Array.prototype.forEach.call(
            dpOverlay.querySelectorAll('[data-dp-day]'),
            function (el) {
              el.onclick = function () {
                var val = el.getAttribute('data-dp-day');
                if (dpInput) {
                  dpInput.value = val;
                  triggerDateInputChange();
                  hideDatePicker();
                }
              };
            }
          );
          var btnToday = dpOverlay.querySelector('[data-dp-today]');
          if (btnToday) {
            btnToday.onclick = function () {
              var d   = new Date();
              var iso = isoFromYMD(d.getFullYear(), d.getMonth(), d.getDate());
              if (dpInput) {
                dpInput.value = formatDateRu(iso);
                triggerDateInputChange();
                hideDatePicker();
              }
            };
          }
          var btnClear = dpOverlay.querySelector('[data-dp-clear]');
          if (btnClear) {
            btnClear.onclick = function () {
              if (dpInput) {
                dpInput.value = '';
                triggerDateInputChange();
                hideDatePicker();
              }
            };
          }
        }
        // Вспомогательные функции
        function isoFromYMD(y, m, d) {
          return y + '-' + ('0' + (m + 1)).slice(-2) + '-' + ('0' + d).slice(-2);
        }
        function formatDateRu(dateStr) {
          if (!dateStr) return '';
          if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
            var p = dateStr.split('-');
            return p[2] + '.' + p[1] + '.' + p[0];
          }
          return dateStr;
        }
        function ruDateToDate(str) {
          if (!str) return null;
          var m = /^(\d{2})\.(\d{2})\.(\d{4})$/.exec(str);
          return m ? new Date(+m[3], +m[2] - 1, +m[1]) : null;
        }
        // Экспортируем функцию для использования в других модулях
        window.attachDateInput = function (id) {
          var input = document.getElementById(id);
          if (!input || input.dataset.dpAttached) return;
          input.dataset.dpAttached = '1';
          input.addEventListener('input', function () {
            var v = input.value;
            var d = v.replace(/\D/g, '');
            if (d.length === 8 && v.indexOf('.') === -1) {
              input.value = d.slice(0, 2) + '.' + d.slice(2, 4) + '.' + d.slice(4);
            }
          });
          input.addEventListener('focus', function () { showDatePickerFor(input); });
          input.addEventListener('click',  function () { showDatePickerFor(input); });
        };
        window.ensureOverlayVisible = ensureOverlayVisible;
      })();
    </script>
    <!-- Модули вкладок -->
    <?!= include('ui_home'); ?>
    <?!= include('ui_contracts'); ?>
    <?!= include('ui_warehouse'); ?>
    <?!= include('ui_pricelist'); ?>
    <?!= include('ui_commercials'); ?>
    <?!= include('ui_analytics'); ?>
  </body>
</html>
